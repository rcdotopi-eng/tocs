<!DOCTYPE html>
<html lang="en">
<head>
    <title>RideLink - Driver</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#28a745">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>

    <div class="container" style="justify-content: center; text-align: center;">
        
        <div style="font-size: 60px; margin-bottom: 10px;">ğŸš–</div>
        <h1>Driver App</h1>

        <div id="view-login" class="card">
            <h3>Partner Login</h3>
            <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
                Earn money by driving.
            </p>

            <button class="btn-primary" onclick="loginWithGoogle()" style="background: white; color: #444; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20">
                Continue with Google
            </button>
            <p id="status-text" style="margin-top: 15px; font-size: 12px; color: #999;"></p>
        </div>

        <div id="view-register" class="card" style="display: none; text-align: left;">
            <h3 style="margin-top:0; color: #28a745;">Driver Registration</h3>
            <p style="font-size: 12px; color: #666;">Fill details to get approved.</p>

            <div class="input-group"><label>Full Name</label><input type="text" id="reg-name"></div>
            <div class="input-group"><label>Parent Name</label><input type="text" id="reg-parent"></div>
            <div class="input-group"><label>Phone</label><input type="tel" id="reg-phone" oninput="formatPhone(this)"></div>
            <div class="input-group"><label>CNIC</label><input type="tel" id="reg-cnic" maxlength="15"></div>
            <div class="input-group"><label>City/Address</label><input type="text" id="reg-address"></div>

            <hr style="margin: 15px 0; border-top: 1px dashed #ddd;">

            <div class="input-group">
                <label>Vehicle Type</label>
                <select id="reg-vehicle-type">
                    <option value="bike">Bike ğŸï¸</option>
                    <option value="rickshaw">Rickshaw ğŸ›º</option>
                    <option value="car">Car ğŸš—</option>
                    <option value="carry">Carry ğŸš</option>
                    <option value="coaster">Coaster ğŸšŒ</option>
                    <option value="loader">Loader ğŸšš</option>
                    <option value="luxury">Luxury Car ğŸš˜</option>
                </select>
            </div>
            <div class="input-group"><label>Plate Number</label><input type="text" id="reg-plate"></div>
            <div class="input-group"><label>Vehicle Color</label><input type="text" id="reg-color"></div>

            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffeeba; margin: 20px 0;">
                <h4 style="margin:0 0 5px 0; color: #856404;">âš ï¸ Joining Fee</h4>
                <p style="font-size: 13px; margin: 0; color: #856404;">
                    Pay <strong>Rs. 1000</strong> to activate account. <br>(Includes Rs. 1000 Wallet Bonus)
                </p>
                <h2 style="text-align: center; margin: 10px 0; color: #333;">0314-6415764</h2>
            </div>

            <button class="btn-green" onclick="submitRegistration()">
                Submit Application
            </button>
        </div>

        <div id="view-pending" class="card" style="display: none;">
            <div style="font-size: 50px;">â³</div>
            <h3 style="color: #e67e22;">Verification Pending</h3>
            <p style="color: #666; font-size: 14px;">
                We are checking your documents.<br>
                Usually takes 2-4 hours.
            </p>
            <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; font-size: 12px; margin-top: 20px;">
                <strong>Admin WhatsApp:</strong><br>0314-6415764
            </div>
            <button onclick="location.reload()" style="margin-top: 20px; background: none; border: 1px solid #ddd; padding: 10px; width: 100%;">
                Check Status Again
            </button>
        </div>

    </div>

    <script src="firebase-init.js"></script>
    <script>
        let googleUser = null;
        let existingData = null;

        // 1. LOGIN
        function loginWithGoogle() {
            const btn = document.querySelector('.btn-primary');
            const txt = document.getElementById('status-text');
            btn.disabled = true; btn.style.opacity = "0.5"; txt.innerText = "Connecting...";

            const provider = new firebase.auth.GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' });

            firebase.auth().signInWithPopup(provider).then((result) => {
                googleUser = result.user;
                checkDatabase(googleUser.uid);
            }).catch((error) => {
                alert(error.message);
                btn.disabled = false; btn.style.opacity = "1";
            });
        }

        // 2. CHECK DATABASE
        function checkDatabase(uid) {
            db.ref('users/' + uid).once('value').then((snapshot) => {
                document.getElementById('view-login').style.display = 'none';

                if (snapshot.exists()) {
                    const data = snapshot.val();
                    existingData = data;
                    localStorage.setItem("taxiUser", JSON.stringify(data));

                    // CHECK SPECIFICALLY FOR DRIVER STATUS
                    if (data.driverStatus === 'active') {
                        // Driver is Approved
                        window.location.href = "driver_app.html";
                    } else if (data.driverStatus === 'pending') {
                        // Driver is Pending
                        document.getElementById('view-pending').style.display = 'block';
                    } else {
                        // User exists (likely a Rider) but NOT a Driver -> Upgrade them
                        showRegistration(true);
                    }
                } else {
                    // New User -> Register
                    showRegistration(false);
                }
            });
        }

        function showRegistration(isUpgrade) {
            document.getElementById('view-register').style.display = 'block';
            document.getElementById('reg-name').value = googleUser.displayName;
            
            // If upgrading, pre-fill phone
            if(isUpgrade && existingData.phone) {
                document.getElementById('reg-phone').value = existingData.phone;
            }
        }

        // 3. SUBMIT REGISTRATION
        function submitRegistration() {
            const updates = {
                name: document.getElementById('reg-name').value,
                parentName: document.getElementById('reg-parent').value,
                phone: document.getElementById('reg-phone').value,
                cnic: document.getElementById('reg-cnic').value,
                address: document.getElementById('reg-address').value,
                vehicleType: document.getElementById('reg-vehicle-type').value,
                vehiclePlate: document.getElementById('reg-plate').value,
                vehicleColor: document.getElementById('reg-color').value,
                email: googleUser.email,
                driverStatus: 'pending' // Only sets Driver status
            };

            if(!updates.name || !updates.phone || !updates.vehiclePlate) return alert("Please fill all fields.");

            // Add Wallet Bonus Logic:
            // If they already have a wallet (e.g. from Rider app), ADD 1000. 
            // If new, start with 1000.
            let currentWallet = existingData && existingData.wallet ? parseInt(existingData.wallet) : 0;
            updates.wallet = currentWallet + 1000;
            
            if(!existingData) updates.joined = Date.now();

            db.ref('users/' + googleUser.uid).update(updates).then(() => {
                if(existingData) Object.assign(existingData, updates);
                localStorage.setItem("taxiUser", JSON.stringify(existingData || updates));
                
                document.getElementById('view-register').style.display = 'none';
                document.getElementById('view-pending').style.display = 'block';
            });
        }

        function formatPhone(input) {
            let v = input.value.replace(/\D/g, ''); 
            if (v.length > 11) v = v.slice(0, 11);
            if (v.length > 4) v = v.slice(0, 4) + "-" + v.slice(4);
            input.value = v;
        }
    </script>
</body>
</html>