<!DOCTYPE html>
<html lang="en">
<head>
    <title>RideLink GEM - Driver Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e293b">
    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body { background: #f0f2f5; font-family: 'Segoe UI', sans-serif; color: #333; }
        
        .container { min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding-top: 40px; }
        
        .card { 
            background: white; width: 100%; max-width: 400px; 
            padding: 30px; border-radius: 15px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: none; 
            margin-bottom: 20px;
        }

        h1 { font-size: 24px; font-weight: 700; color: #1e293b; margin-bottom: 5px; }
        
        /* Inputs */
        .input-group { margin-bottom: 15px; text-align: left; width: 100%; }
        .input-group label { display: block; font-size: 12px; color: #64748b; margin-bottom: 5px; font-weight: 600; }
        .input-group input, .input-group select { 
            width: 100%; padding: 12px; border: 1px solid #e2e8f0; 
            border-radius: 8px; font-size: 16px; background: #f8fafc; 
            box-sizing: border-box;
        }
        .input-group input:focus, .input-group select:focus { border-color: #10b981; outline: none; background: #fff; }

        /* Buttons */
        .btn-google { 
            background: white; color: #333; border: 1px solid #cbd5e1; 
            width: 100%; padding: 12px; border-radius: 10px; font-weight: 600;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: 0.2s;
        }
        .btn-google:active { background: #f1f5f9; transform: scale(0.98); }

        .btn-green { 
            background: #10b981; color: white; border: none; 
            width: 100%; padding: 14px; border-radius: 10px; 
            font-size: 16px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
            transition: 0.2s;
        }
        .btn-green:active { transform: scale(0.98); }

        .status-box { background: #fffbeb; border: 1px solid #fcd34d; color: #92400e; padding: 15px; border-radius: 8px; font-size: 13px; line-height: 1.5; margin: 20px 0; text-align: left; }
    </style>
</head>
<body>

    <div class="container">
        
        <div style="font-size: 50px; margin-bottom: 10px;">üöñ</div>
        <h1>RideLink Partner</h1>
        <p style="color:#64748b; margin-bottom: 30px;">Drive & Earn on your own schedule</p>

        <div id="view-login" class="card">
            <h3 style="margin-top:0;">Login</h3>
            <p style="color: #64748b; font-size: 14px; margin-bottom: 25px;">
                Sign in to access your dashboard or register as a new driver.
            </p>

            <button class="btn-google" onclick="loginWithGoogle()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20">
                Continue with Google
            </button>
            <p id="status-text" style="margin-top: 20px; font-size: 13px; color: #94a3b8; font-weight: 500;"></p>
        </div>

        <div id="view-register" class="card" style="display: none;">
            <h3 style="margin-top:0; color: #10b981;">Driver Registration</h3>
            <p style="font-size: 13px; color: #64748b;">Complete your profile to get approved.</p>
            <hr>

            <div class="input-group"><label>Full Name</label><input type="text" id="reg-name"></div>
            <div class="input-group"><label>Parent/Guardian Name</label><input type="text" id="reg-parent"></div>
            <div class="input-group"><label>Phone Number</label><input type="tel" id="reg-phone" oninput="formatPhone(this)" placeholder="03xx-xxxxxxx"></div>
            <div class="input-group"><label>CNIC Number</label><input type="tel" id="reg-cnic" maxlength="15"></div>
            <div class="input-group"><label>City / Area</label><input type="text" id="reg-address"></div>

            <hr style="margin: 20px 0; border-top: 1px dashed #e2e8f0;">

            <div class="input-group">
                <label>Vehicle Type</label>
                <select id="reg-vehicle-type">
                    <option value="">Select Type...</option>
                    <option value="bike">Bike üèçÔ∏è</option>
                    <option value="rickshaw">Rickshaw üõ∫</option>
                    <option value="car">Car üöó</option>
                    <option value="carry">Carry üöê</option>
                    <option value="coaster">Coaster üöå</option>
                    <option value="loader">Loader üöö</option>
                    <option value="luxury">Luxury Car üöò</option>
                </select>
            </div>
            <div class="input-group"><label>Vehicle Plate Number</label><input type="text" id="reg-plate" placeholder="ABC-123"></div>
            <div class="input-group"><label>Vehicle Color</label><input type="text" id="reg-color"></div>

            <div class="status-box">
                <strong>üéÅ Welcome Bonus:</strong><br>
                Your wallet will be credited with <strong>Rs. 1000</strong> upon registration submission.
                <br><br>
                <strong>üìû Support:</strong> 0314-6415764
            </div>

            <button class="btn-green" onclick="submitRegistration()">Submit Application</button>
        </div>

        <div id="view-pending" class="card" style="display: none; text-align: center;">
            <div style="font-size: 60px; margin-bottom: 15px;">‚è≥</div>
            <h3 style="color: #d97706;">Verification Pending</h3>
            <p style="color: #64748b; font-size: 14px; line-height: 1.6;">
                Your documents have been submitted.<br>
                Admin verification usually takes <strong>2-4 hours</strong>.
            </p>
            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px solid #e2e8f0;">
                <small style="color:#64748b; text-transform: uppercase; font-weight: bold;">Admin Contact</small><br>
                <strong style="color: #1e293b; font-size: 16px;">0314-6415764</strong>
            </div>
            <button onclick="location.reload()" class="btn-google" style="margin-top: 20px; justify-content: center;">
                Check Status Again
            </button>
        </div>

    </div>

    <script src="firebase-init.js"></script>
    <script>
        let googleUser = null;
        let existingData = null;

        // 1. LOGIN FLOW
        function loginWithGoogle() {
            const btn = document.querySelector('.btn-google');
            const txt = document.getElementById('status-text');
            
            btn.style.opacity = "0.5"; 
            btn.style.pointerEvents = "none";
            txt.innerText = "Connecting to Google...";

            const provider = new firebase.auth.GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' });

            firebase.auth().signInWithPopup(provider)
                .then((result) => {
                    googleUser = result.user;
                    txt.innerText = "Checking Database...";
                    checkDatabase(googleUser.uid);
                })
                .catch((error) => {
                    alert("Login Failed: " + error.message);
                    btn.style.opacity = "1";
                    btn.style.pointerEvents = "auto";
                    txt.innerText = "";
                });
        }

        // 2. CHECK USER STATUS
        function checkDatabase(uid) {
            db.ref('users/' + uid).once('value').then((snapshot) => {
                document.getElementById('view-login').style.display = 'none';

                if (snapshot.exists()) {
                    existingData = snapshot.val();
                    // SAVE ID to local storage explicitly for app usage
                    existingData.id = uid; 
                    localStorage.setItem("driverUser", JSON.stringify(existingData));

                    // ROUTING LOGIC
                    if (existingData.driverStatus === 'active') {
                        // APPROVED -> Go to App
                        window.location.href = "driver_app.html";
                    } else if (existingData.driverStatus === 'pending') {
                        // PENDING -> Show Wait Screen
                        document.getElementById('view-pending').style.display = 'block';
                    } else {
                        // BLOCKED or Rider trying to become Driver -> Show Form
                        showRegistration(true);
                    }
                } else {
                    // NEW USER -> Show Form
                    showRegistration(false);
                }
            });
        }

        function showRegistration(isUpgrade) {
            document.getElementById('view-register').style.display = 'block';
            document.getElementById('reg-name').value = googleUser.displayName || "";
            
            // If they were a rider, pre-fill phone
            if(isUpgrade && existingData && existingData.phone) {
                document.getElementById('reg-phone').value = existingData.phone;
            }
        }

        // 3. SUBMIT FORM
        function submitRegistration() {
            const name = document.getElementById('reg-name').value;
            const parent = document.getElementById('reg-parent').value;
            const phone = document.getElementById('reg-phone').value;
            const cnic = document.getElementById('reg-cnic').value;
            const address = document.getElementById('reg-address').value;
            const vType = document.getElementById('reg-vehicle-type').value;
            const vPlate = document.getElementById('reg-plate').value;
            const vColor = document.getElementById('reg-color').value;

            if(!name || !phone || !cnic || !vType || !vPlate) {
                return alert("Please fill all required fields.");
            }

            // Wallet Logic: Add 1000 if new driver
            let currentWallet = (existingData && existingData.wallet) ? parseInt(existingData.wallet) : 0;
            // Only add bonus if they aren't already a driver (prevent double bonus on profile edit)
            if(!existingData || !existingData.driverStatus) {
                currentWallet += 1000;
            }

            const updates = {
                id: googleUser.uid, // Ensuring ID is saved in DB
                name: name,
                parentName: parent,
                phone: phone,
                cnic: cnic,
                address: address,
                vehicleType: vType,
                vehiclePlate: vPlate,
                vehicleColor: vColor,
                email: googleUser.email,
                driverStatus: 'pending', // Send to Pending
                wallet: currentWallet,
                role: 'driver', // Mark as driver
                updatedAt: Date.now()
            };

            if(!existingData) updates.joined = Date.now();

            db.ref('users/' + googleUser.uid).update(updates).then(() => {
                // Update Local Storage
                if(existingData) Object.assign(existingData, updates);
                else existingData = updates;
                
                localStorage.setItem("driverUser", JSON.stringify(existingData));
                
                // Show Pending Screen
                document.getElementById('view-register').style.display = 'none';
                document.getElementById('view-pending').style.display = 'block';
                window.scrollTo(0,0);
            });
        }

        function formatPhone(input) {
            let v = input.value.replace(/\D/g, ''); 
            if (v.length > 11) v = v.slice(0, 11);
            if (v.length > 4) v = v.slice(0, 4) + "-" + v.slice(4);
            input.value = v;
        }
    </script>
</body>
</html>
