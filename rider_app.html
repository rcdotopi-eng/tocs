// GLOBAL VARIABLES
    let riderUser = null;
    let riderVehicle = null;
    let isRiderProcessing = false;
    let activeReqRef = null;
    let currentReqId = null;
    let currentReqData = null;

    // --- INIT ---
    window.onload = function() {
        if(typeof firebase === 'undefined') {
            console.error("Firebase not loaded");
            return;
        }
        if(firebase.auth().currentUser) {
            initApp(firebase.auth().currentUser);
        } else {
            firebase.auth().onAuthStateChanged(user => {
                if(user) initApp(user);
                else window.location.href = "index.html";
            });
        }
    };

    function initApp(user) {
        const saved = localStorage.getItem("taxiUser");
        if (saved) {
            riderUser = JSON.parse(saved);
            riderUser.id = user.uid;
        } else {
            riderUser = { id: user.uid, name: user.displayName || 'Rider', phone: '' };
        }

        if(riderUser.phone) {
            const phoneInput = document.getElementById('inp-phone');
            if(phoneInput) phoneInput.value = riderUser.phone;
        }

        loadMyActiveRequests();
    }

    // --- VEHICLE SELECTION ---
    function selectVehicle(id, elementId) {
        riderVehicle = id;
        // Remove 'selected' class from all items
        document.querySelectorAll('.vehicle-item').forEach(el => el.classList.remove('selected'));
        // Add 'selected' class to the clicked item
        const el = document.getElementById(elementId);
        if(el) el.classList.add('selected');
    }

    // --- REQUEST PROCESS ---
    function startRequestProcess() {
        // Check blocked status
        db.ref('users/' + riderUser.id + '/isBlocked').once('value', snap => {
            if(snap.val() === true) {
                return alert("ðŸš« You are blocked from making new requests due to previous penalty unpaid.");
            }
            
            const pickup = document.getElementById('inp-pickup').value;
            const drop = document.getElementById('inp-drop').value;
            const phone = document.getElementById('inp-phone').value;
            
            if(!pickup || !drop || !phone) return alert("Please fill all fields.");
            if(!riderVehicle) return alert("Please select a Vehicle Type.");

            isRiderProcessing = true;
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-text').innerText = "ðŸ›°ï¸ Acquiring GPS...";
            document.getElementById('cancel-gps-btn').style.display = 'block';

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        if(!isRiderProcessing) return; 
                        document.getElementById('loading-text').innerText = "âœ… GPS Found! Sending...";
                        setTimeout(() => {
                            sendToBackend(position.coords.latitude, position.coords.longitude);
                        }, 1000);
                    },
                    (error) => {
                        if(!isRiderProcessing) return;
                        document.getElementById('loading-overlay').style.display = 'none';
                        alert("âš ï¸ Weak GPS Signal! Move outdoors.");
                    },
                    { timeout: 15000, enableHighAccuracy: true }
                );
            } else {
                alert("GPS not supported.");
                document.getElementById('loading-overlay').style.display = 'none';
            }
        });
    }

    function sendToBackend(lat, lng) {
        const requestData = {
            riderId: riderUser.id,
            riderName: riderUser.name || 'Rider',
            riderPhone: document.getElementById('inp-phone').value,
            pickup: document.getElementById('inp-pickup').value,
            drop: document.getElementById('inp-drop').value,
            landmark: document.getElementById('inp-landmark').value || "",
            vehicleType: riderVehicle,
            lat: lat,
            lng: lng,
            status: 'pending',
            timestamp: firebase.database.ServerValue.TIMESTAMP
        };

        db.ref('requests').push(requestData).then((snap) => {
            isRiderProcessing = false;
            document.getElementById('loading-overlay').style.display = 'none';
            alert("âœ… Request Sent Successfully!");
            
            // Reset Form
            document.getElementById('inp-pickup').value = "";
            document.getElementById('inp-drop').value = "";
            document.getElementById('inp-landmark').value = "";
            riderVehicle = null;
            document.querySelectorAll('.vehicle-item').forEach(el => el.classList.remove('selected'));
        }).catch(error => {
            alert("Error: " + error.message);
            cancelProcess();
        });
    }

    function cancelProcess() {
        isRiderProcessing = false;
        document.getElementById('loading-overlay').style.display = 'none';
    }

    // --- SINGLE ACTIVE REQUEST LOGIC (FIXED) ---
    function loadMyActiveRequests() {
        if(!riderUser || !riderUser.id) return;
        
        db.ref('requests').orderByChild('riderId').equalTo(riderUser.id).on('value', (snap) => {
            let activeReq = null;
            let activeId = null;

            if (snap.exists()) {
                snap.forEach(child => {
                    const r = child.val();
                    
                    // ðŸ›‘ DOUBLE CHECK: ID MUST MATCH
                    if (r.riderId !== riderUser.id) return;

                    // Consider these active statuses
                    if(r.status !== 'deleted' && r.status !== 'completed' && r.status !== 'CANCELLED') {
                        activeReq = r;
                        activeId = child.key;
                    }
                });
            }

            // Toggle UI based on active request
            const newReqContainer = document.getElementById('new-request-container');
            const activeReqContainer = document.getElementById('active-ride-container');

            if (activeReq) {
                currentReqId = activeId;
                if(newReqContainer) newReqContainer.style.display = 'none';
                if(activeReqContainer) activeReqContainer.style.display = 'block';
                
                // Update Active Card UI
                let st = activeReq.status.toUpperCase();
                if(activeReq.status === 'pending' && activeReq.bids) st = "OFFERS RECEIVED";
                
                document.getElementById('card-status').innerText = st;
                document.getElementById('card-route').innerText = `${activeReq.pickup} âž¡ ${activeReq.drop}`;
            } else {
                currentReqId = null;
                if(newReqContainer) newReqContainer.style.display = 'block';
                if(activeReqContainer) activeReqContainer.style.display = 'none';
                // If details open, close it
                closeDetails();
            }
        });
    }

    function openCurrentRequest() {
        if(currentReqId) openRequestDetails(currentReqId);
    }

    // --- DETAILS & BIDDING UI ---
    function openRequestDetails(reqId) {
        document.getElementById('view-home').style.display = 'none';
        document.getElementById('view-details').style.display = 'block';

        if(activeReqRef) activeReqRef.off();
        activeReqRef = db.ref('requests/' + reqId);

        activeReqRef.on('value', snap => {
            if(!snap.exists()) { closeDetails(); return; }
            const r = snap.val();
            currentReqData = r;

            // Status Logic
            let st = r.status.toUpperCase();
            if(r.status === 'pending' && r.bids) st = "OFFERS RECEIVED";
            document.getElementById('det-status').innerText = st;
            
            document.getElementById('det-pickup').innerText = r.pickup;
            document.getElementById('det-drop').innerText = r.drop;
            document.getElementById('det-price').innerText = r.agreedPrice ? "Rs. " + r.agreedPrice : "TBD";

            // DRIVER ETA PROMPT LOGIC
            const alertBox = document.getElementById('driver-status-alert');
            if(r.driverStatus) {
                alertBox.style.display = 'block';
                document.getElementById('driver-msg').innerText = r.driverStatus;
            } else {
                alertBox.style.display = 'none';
            }

            const sectionBids = document.getElementById('section-bids');
            const sectionConf = document.getElementById('section-confirmed');
            const btnCancel = document.getElementById('btn-cancel-ride');

            // State Management
            if(r.status === 'CONFIRMED') {
                sectionBids.style.display = 'none';
                sectionConf.style.display = 'block';
                btnCancel.innerText = "Cancel Confirmed Ride (Penalty Applies)";
            } else {
                // Pending / Offers Received
                sectionBids.style.display = 'block';
                sectionConf.style.display = 'none';
                btnCancel.innerText = "Delete Pending Request";
                renderBids(r.bids, reqId);
            }
        });
    }

    function renderBids(bids, reqId) {
        const list = document.getElementById('bids-list');
        list.innerHTML = '';
        if(!bids) {
            list.innerHTML = '<p class="text-muted">Waiting for drivers...</p>';
            return;
        }
        Object.keys(bids).forEach(key => {
            const bid = bids[key];
            const div = document.createElement('div');
            div.className = 'bid-card';
            div.innerHTML = `
                <div>
                    <strong>${bid.driverName}</strong><br>
                    <small>${bid.vehicleModel} (${bid.vehiclePlate})</small>
                </div>
                <div style="text-align:right;">
                    <div style="font-weight:bold; color:#28a745;">Rs. ${bid.price}</div>
                    <button class="btn-accept" onclick="acceptOffer('${reqId}', '${key}', ${bid.price})">Accept</button>
                </div>
            `;
            list.appendChild(div);
        });
    }

    function acceptOffer(reqId, driverId, price) {
        if(!confirm("Confirm ride for Rs. " + price + "?")) return;
        
        db.ref('requests/' + reqId).update({
            status: 'CONFIRMED',
            selectedDriverId: driverId,
            agreedPrice: price,
            confirmedAt: firebase.database.ServerValue.TIMESTAMP
        });

        // Delete other bids
        db.ref('requests/' + reqId + '/bids').once('value', snap => {
            snap.forEach(child => {
                if(child.key !== driverId) {
                    child.ref.remove();
                }
            });
        });
    }

    function triggerCancel() {
        if(!currentReqData) return;
        const status = currentReqData.status;

        if(status === 'CONFIRMED') {
            // STRICT PENALTY LOGIC
            const msg = "Cancelling a confirmed offer will fine you 300 rupees. You will not be able to request any future ride before paying this fine.";
            if(confirm(msg)) {
                // Deduct Balance & Block
                const userRef = db.ref('users/' + riderUser.id);
                userRef.child('balance').once('value', snap => {
                    const currentBal = snap.val() || 0;
                    userRef.update({
                        balance: currentBal - 300,
                        isBlocked: true
                    });
                });

                // Cancel Request
                db.ref('requests/' + currentReqId).update({
                    status: 'CANCELLED',
                    cancelledBy: 'RIDER',
                    cancellationReason: 'CONFIRMED_CANCEL_PENALTY'
                });
                closeDetails();
            }
        } else {
            // No Penalty for Pending/Offers
            if(confirm("Delete this request? This will reject all offers.")) {
                db.ref('requests/' + currentReqId).update({ status: 'CANCELLED', cancelledBy: 'RIDER' });
                closeDetails();
            }
        }
    }

    function closeDetails() {
        document.getElementById('view-details').style.display = 'none';
        document.getElementById('view-home').style.display = 'block';
        if(activeReqRef) activeReqRef.off();
    }

    function logout() {
        firebase.auth().signOut();
        localStorage.removeItem("taxiUser");
        window.location.href = "index.html";
    }
