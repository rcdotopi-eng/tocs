<!DOCTYPE html>
<html lang="en">
<head>
    <title>Request Ride - RideLink</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#007bff">
    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body { background: #f4f6f9; padding-bottom: 100px; font-family: sans-serif; }
        
        /* HEADER */
        .page-header { background: #fff; padding: 15px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .page-header h2 { margin: 0; font-size: 18px; color: #333; }
        .logout-btn { color: #dc3545; font-size: 13px; font-weight: bold; cursor: pointer; text-decoration: underline;}

        /* FORM CARD */
        .form-card { background: white; margin: 15px; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 12px; color: #666; margin-bottom: 5px; font-weight: 600; }
        .input-group input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; background: #fafafa; }
        .input-group input:focus { border-color: #007bff; outline: none; background: #fff; }

        /* VEHICLE GRID */
        .grid-title { margin: 0 15px 10px; font-size: 14px; font-weight: bold; color: #555; }
        .vehicle-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 0 15px; }
        .vehicle-item { background: white; border: 2px solid #eee; border-radius: 10px; padding: 15px 5px; text-align: center; cursor: pointer; transition: 0.2s; user-select: none; }
        .vehicle-item.selected { border-color: #007bff; background-color: #e3f2fd; box-shadow: 0 0 8px rgba(0,123,255,0.4); transform: scale(1.02); }
        .v-icon { font-size: 28px; display: block; margin-bottom: 5px; }
        .v-name { font-size: 11px; font-weight: 600; color: #444; }

        /* REQUEST CARD */
        .requests-section { margin-top: 30px; padding: 15px; }
        .req-card { background: white; padding: 15px; border-radius: 8px; border-left: 5px solid #ffc107; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; cursor: pointer; }
        .req-status { float: right; font-size: 12px; font-weight: bold; color: #ffc107; margin-right: 20px;}

        /* BOTTOM BUTTON */
        .bottom-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); text-align: center; box-sizing: border-box; z-index: 100; }
        .btn-primary { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; }

        /* LOADING OVERLAY */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; color: white; text-align: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="page-header">
        <h2>Request a Ride</h2>
        <a class="logout-btn" onclick="logout()">Logout</a>
    </div>

    <div class="form-card">
        <div class="input-group">
            <label>Pickup Point <span style="color:red">*</span></label>
            <input type="text" id="inp-pickup" placeholder="Enter Pickup Location">
        </div>
        <div class="input-group">
            <label>Dropping Point <span style="color:red">*</span></label>
            <input type="text" id="inp-drop" placeholder="Enter Drop Location">
        </div>
        <div class="input-group">
            <label>Landmark (Optional)</label>
            <input type="text" id="inp-landmark" placeholder="Near Masjid, Park, etc.">
        </div>
        <div class="input-group">
            <label>Contact Number <span style="color:red">*</span></label>
            <input type="tel" id="inp-phone" placeholder="0300-1234567">
        </div>
    </div>

    <div class="grid-title">Select Vehicle Type</div>
    
    <div class="vehicle-grid">
        <div class="vehicle-item" id="v-bike" onclick="selectVehicle('bike', 'v-bike')"><span class="v-icon">üèçÔ∏è</span><span class="v-name">Bike</span></div>
        <div class="vehicle-item" id="v-rickshaw" onclick="selectVehicle('rickshaw', 'v-rickshaw')"><span class="v-icon">üõ∫</span><span class="v-name">Rickshaw</span></div>
        <div class="vehicle-item" id="v-car" onclick="selectVehicle('car', 'v-car')"><span class="v-icon">üöó</span><span class="v-name">Car</span></div>
        <div class="vehicle-item" id="v-carry" onclick="selectVehicle('carry', 'v-carry')"><span class="v-icon">üöê</span><span class="v-name">Carry Daba</span></div>
        <div class="vehicle-item" id="v-coaster" onclick="selectVehicle('coaster', 'v-coaster')"><span class="v-icon">üöå</span><span class="v-name">Coaster</span></div>
        <div class="vehicle-item" id="v-loader" onclick="selectVehicle('loader', 'v-loader')"><span class="v-icon">üöö</span><span class="v-name">Loader</span></div>
        <div class="vehicle-item" id="v-luxury" onclick="selectVehicle('luxury', 'v-luxury')"><span class="v-icon">üöò</span><span class="v-name">Luxury</span></div>
    </div>

    <div class="requests-section">
        <h4 style="margin-bottom: 10px; color: #555; font-size: 14px;">My Active Requests</h4>
        <div id="my-requests-list">
            <p style="color:#999; font-size:12px; text-align: center;">Loading...</p>
        </div>
    </div>

    <div class="bottom-bar">
        <button class="btn-primary" onclick="startRequestProcess()">Submit Request</button>
    </div>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <h3>Please Wait...</h3>
        <p id="loading-text" style="font-size: 16px; margin-top: 15px; font-weight:bold;">Initializing...</p>
        <button id="cancel-gps-btn" onclick="cancelProcess()" style="margin-top: 25px; background: transparent; border: 1px solid white; color: white; padding: 8px 25px; border-radius: 20px; font-size: 14px; display:none;">Cancel</button>
    </div>

    <script src="firebase-init.js"></script>
    <script>
        // GLOBAL VARIABLES
        let riderUser = null;
        let riderVehicle = null;
        let isRiderProcessing = false;

        // --- INIT ---
        window.onload = function() {
            // Wait for Firebase to check Auth
            if(firebase.auth().currentUser) {
                initApp(firebase.auth().currentUser);
            } else {
                firebase.auth().onAuthStateChanged(user => {
                    if(user) initApp(user);
                    else window.location.href = "index.html"; // Changed from rider_login.html
                });
            }
        };

        function initApp(user) {
            // Try to get user from local storage, or build from Auth
            const saved = localStorage.getItem("taxiUser");
            if (saved) {
                riderUser = JSON.parse(saved);
                // Ensure ID matches current auth
                riderUser.id = user.uid;
            } else {
                riderUser = { id: user.uid, name: user.displayName || 'Rider', phone: '' };
            }

            // Auto-fill phone
            if(riderUser.phone) {
                document.getElementById('inp-phone').value = riderUser.phone;
            }

            loadMyActiveRequests();
        }

        // --- SELECT VEHICLE ---
        function selectVehicle(id, elementId) {
            riderVehicle = id;
            document.querySelectorAll('.vehicle-item').forEach(el => el.classList.remove('selected'));
            document.getElementById(elementId).classList.add('selected');
        }

        // --- SUBMIT PROCESS (STRICT GPS) ---
        function startRequestProcess() {
            const pickup = document.getElementById('inp-pickup').value;
            const drop = document.getElementById('inp-drop').value;
            const phone = document.getElementById('inp-phone').value;
            
            if(!pickup || !drop || !phone) return alert("Please fill all fields.");
            if(!riderVehicle) return alert("Please select a Vehicle Type.");

            isRiderProcessing = true;
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-text').innerText = "üõ∞Ô∏è Acquiring GPS...";
            document.getElementById('cancel-gps-btn').style.display = 'block';

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        if(!isRiderProcessing) return; 
                        document.getElementById('loading-text').innerText = "‚úÖ GPS Found! Sending...";
                        setTimeout(() => {
                            sendToBackend(position.coords.latitude, position.coords.longitude);
                        }, 1000);
                    },
                    (error) => {
                        if(!isRiderProcessing) return;
                        document.getElementById('loading-overlay').style.display = 'none';
                        if(error.code === 1) {
                            alert("Permission Denied. Please enable Location in your browser settings.");
                        } else {
                            alert("‚ö†Ô∏è Weak GPS Signal!\n\nPlease move to an open area (outdoors) to get a signal. We cannot book without your location.");
                        }
                    },
                    { timeout: 15000, enableHighAccuracy: true }
                );
            } else {
                alert("GPS not supported.");
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }

        // --- SEND TO BACKEND ---
        function sendToBackend(lat, lng) {
            const requestData = {
                riderId: riderUser.id,
                riderName: riderUser.name || 'Rider',
                riderPhone: document.getElementById('inp-phone').value,
                pickup: document.getElementById('inp-pickup').value,
                drop: document.getElementById('inp-drop').value,
                landmark: document.getElementById('inp-landmark').value,
                vehicleType: riderVehicle,
                lat: lat,
                lng: lng,
                status: 'pending',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            db.ref('requests').push(requestData).then((snap) => {
                isRiderProcessing = false;
                document.getElementById('loading-overlay').style.display = 'none';
                
                alert("‚úÖ Request Sent Successfully!");
                
                // --- RESET FORM ---
                document.getElementById('inp-pickup').value = "";
                document.getElementById('inp-drop').value = "";
                document.getElementById('inp-landmark').value = "";
                
                riderVehicle = null;
                document.querySelectorAll('.vehicle-item').forEach(el => el.classList.remove('selected'));
                
            }).catch(error => {
                alert("Error: " + error.message);
                cancelProcess();
            });
        }

        function cancelProcess() {
            isRiderProcessing = false;
            document.getElementById('loading-overlay').style.display = 'none';
        }

        // --- LOAD ALL ACTIVE REQUESTS ---
        function loadMyActiveRequests() {
            if(!riderUser || !riderUser.id) return;
            
            db.ref('requests').orderByChild('riderId').equalTo(riderUser.id).on('value', (snap) => {
                const container = document.getElementById('my-requests-list');
                
                if(!snap.exists()) {
                    container.innerHTML = '<p style="color:#999; text-align: center; margin-top:20px;">No active requests.</p>';
                    return;
                }

                container.innerHTML = ''; 

                let reqList = [];
                snap.forEach(child => {
                    reqList.push({ key: child.key, data: child.val() });
                });
                reqList.reverse();

                let count = 0;
                reqList.forEach(item => {
                    const req = item.data;
                    
                    if(req.status === 'deleted' || req.status === 'cancelled' || req.status === 'completed') return;

                    count++;
                    const div = document.createElement('div');
                    div.className = 'req-card';
                    
                    // OPEN DETAILS (You can link this to your details page)
                    // For now, let's just alert
                    div.onclick = function() {
                        // If you have a details page, uncomment below:
                        // window.location.href = "rider_details.html?id=" + item.key;
                        alert("Ride: " + req.pickup + " to " + req.drop + "\nStatus: " + req.status);
                    };

                    div.innerHTML = `
                        <span class="req-status">${req.status.toUpperCase()}</span>
                        <span class="req-arrow">‚ùØ</span>
                        <strong>${req.pickup}</strong> to <strong>${req.drop}</strong><br>
                        <small style="color:#666;">Vehicle: ${req.vehicleType}</small>
                    `;
                    container.appendChild(div);
                });

                if(count === 0) {
                    container.innerHTML = '<p style="color:#999; text-align: center; margin-top:20px;">No active requests.</p>';
                }
            });
        }

        function logout() {
            firebase.auth().signOut();
            localStorage.removeItem("taxiUser");
            window.location.href = "index.html";
        }
    </script>
</body>
</html>
