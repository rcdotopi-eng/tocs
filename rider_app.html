<!DOCTYPE html>
<html lang="en">
<head>
    <title>RideLink - Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#007bff">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        /* Specific Styles for Rider Dashboard */
        .profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .wallet-badge {
            background: #e9f7ef;
            color: #28a745;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        .driver-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: left;
            border-left: 4px solid var(--primary-color);
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-accepted { background: #d4edda; color: #155724; }
        
        /* Pulse Animation for Searching */
        .radar-spinner {
            width: 60px; height: 60px;
            background-color: var(--primary-color);
            border-radius: 100%;
            margin: 20px auto;
            animation: sk-scaleout 1.0s infinite ease-in-out;
        }
        @keyframes sk-scaleout {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1.0); opacity: 0.5; }
        }
    </style>
</head>
<body>

    <div class="container">
        
        <div class="profile-header">
            <div>
                <h3 style="margin:0;" id="user-name">Loading...</h3>
                <span class="wallet-badge">Wallet: Rs. <span id="wallet-balance">0</span></span>
            </div>
            <button onclick="logout()" style="width: auto; padding: 8px 15px; background: #eee; color: #333; font-size: 12px;">
                Logout
            </button>
        </div>

        <div id="view-book" class="card">
            <h3>Where to?</h3>
            
            <div class="input-group">
                <label>Pickup Location</label>
                <input type="text" id="pickup" placeholder="e.g. Blue Area, Islamabad">
            </div>
            
            <div class="input-group">
                <label>Drop Location</label>
                <input type="text" id="drop" placeholder="e.g. F-10 Markaz">
            </div>

            <div class="input-group">
                <label>Vehicle Type</label>
                <select id="vehicle">
                    <option value="Bike">Bike üèçÔ∏è</option>
                    <option value="Rickshaw">Rickshaw üõ∫</option>
                    <option value="Car">Car üöó</option>
                    <option value="AC Car">AC Car ‚ùÑÔ∏è</option>
                </select>
            </div>

            <button class="btn-primary" onclick="requestRide()">Find Captain</button>
        </div>

        <div id="view-searching" class="card" style="display: none; text-align: center;">
            <div class="radar-spinner"></div>
            <h3>Connecting...</h3>
            <p style="color: #666; font-size: 14px;">Looking for nearby captains.</p>
            <button class="btn-danger" onclick="cancelRide()" style="margin-top: 20px;">Cancel Request</button>
        </div>

        <div id="view-ride" class="card" style="display: none; text-align: center;">
            <span class="status-badge status-accepted">Captain Found</span>
            <h2 style="margin: 10px 0;">On The Way</h2>
            
            <div class="driver-info">
                <h3 style="margin: 0;" id="driver-name">Driver Name</h3>
                <p style="margin: 5px 0; color: #666;" id="driver-car">Vehicle Details</p>
                <h2 style="margin: 10px 0; color: var(--primary-color);" id="ride-price">Rs. 0</h2>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <a id="call-driver-btn" href="#" style="flex: 1; text-decoration: none;">
                    <button class="btn-green">üìû Call</button>
                </a>
                <button class="btn-danger" style="flex: 1;" onclick="cancelRide()">Cancel</button>
            </div>
        </div>

    </div>

    <script src="firebase-init.js"></script>
    
    <script>
        let currentUser = null;
        let currentRideId = null;
        let rideListener = null;

        // --- 1. INITIALIZATION & AUTH ---
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                loadUserProfile();
                restoreSession(); // Check if user already has a ride
            } else {
                window.location.href = "index.html";
            }
        });

        function loadUserProfile() {
            db.ref('users/' + currentUser.uid).once('value').then(snap => {
                if(snap.exists()) {
                    const data = snap.val();
                    document.getElementById('user-name').innerText = "Hi, " + data.name.split(' ')[0];
                    document.getElementById('wallet-balance').innerText = data.wallet || 0;
                    
                    // Security Check: If not approved, kick back
                    if(data.riderStatus !== 'active') window.location.href = "index.html";
                }
            });
        }

        // --- 2. RIDE LOGIC ---

        function requestRide() {
            const pickup = document.getElementById('pickup').value;
            const drop = document.getElementById('drop').value;
            const vehicle = document.getElementById('vehicle').value;

            if(!pickup || !drop) return alert("Please enter locations");

            const btn = document.querySelector('.btn-primary');
            btn.disabled = true; btn.innerText = "Processing...";

            // Create Request Object
            const requestData = {
                riderId: currentUser.uid,
                riderName: currentUser.displayName || "Passenger",
                pickup: pickup,
                drop: drop,
                vehicle: vehicle,
                status: 'pending',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            // Push to Firebase
            const newRef = db.ref('requests').push();
            currentRideId = newRef.key;
            
            newRef.set(requestData).then(() => {
                localStorage.setItem("currentRideId", currentRideId);
                startRideListener(currentRideId);
            });
        }

        // Listen for changes (Driver Accept / Complete)
        function startRideListener(rideId) {
            const rideRef = db.ref('requests/' + rideId);
            
            rideListener = rideRef.on('value', (snapshot) => {
                const ride = snapshot.val();
                
                // If ride deleted or null
                if (!ride) {
                    resetApp();
                    return;
                }

                // HANDLE STATUSES
                if (ride.status === 'pending') {
                    showView('view-searching');
                } 
                else if (ride.status === 'accepted') {
                    showView('view-ride');
                    updateDriverUI(ride);
                } 
                else if (ride.status === 'completed') {
                    alert("Ride Completed! Thank you.");
                    rideRef.off(); // Stop listening
                    resetApp();
                }
                else if (ride.status === 'cancelled') {
                    alert("Ride was cancelled.");
                    resetApp();
                }
            });
        }

        function cancelRide() {
            if(!currentRideId) return;
            if(!confirm("Are you sure you want to cancel?")) return;

            db.ref('requests/' + currentRideId).update({
                status: 'cancelled'
            }).then(() => {
                resetApp();
            });
        }

        // --- 3. HELPER FUNCTIONS ---

        function updateDriverUI(ride) {
            document.getElementById('driver-name').innerText = ride.driverName || "Driver Assigned";
            document.getElementById('driver-car').innerText = (ride.vehicleModel || "") + " ‚Ä¢ " + (ride.vehiclePlate || "");
            document.getElementById('ride-price').innerText = "Rs. " + (ride.price || "Negotiating");
            
            if(ride.driverPhone) {
                document.getElementById('call-driver-btn').href = "tel:" + ride.driverPhone;
            }
        }

        // Check if user closed app while in a ride
        function restoreSession() {
            const savedRideId = localStorage.getItem("currentRideId");
            if(savedRideId) {
                // Check if this ride is still active in DB
                db.ref('requests/' + savedRideId).once('value').then(snap => {
                    if(snap.exists() && 
                       (snap.val().status === 'pending' || snap.val().status === 'accepted')) {
                        currentRideId = savedRideId;
                        startRideListener(currentRideId);
                    } else {
                        localStorage.removeItem("currentRideId");
                        showView('view-book');
                    }
                });
            } else {
                showView('view-book');
            }
        }

        function resetApp() {
            localStorage.removeItem("currentRideId");
            currentRideId = null;
            if(rideListener) db.ref('requests').off(); // Detach listeners
            
            // Reset Inputs
            document.getElementById('pickup').value = "";
            document.getElementById('drop').value = "";
            
            // Reset Button
            const btn = document.querySelector('#view-book .btn-primary');
            btn.disabled = false; btn.innerText = "Find Captain";

            showView('view-book');
        }

        function showView(viewId) {
            // Hide all
            ['view-book', 'view-searching', 'view-ride'].forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
            // Show target
            document.getElementById(viewId).style.display = 'block';
        }

        function logout() {
            firebase.auth().signOut().then(() => {
                window.location.href = "index.html";
            });
        }
    </script>
</body>
</html>
