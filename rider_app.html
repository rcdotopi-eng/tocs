<!DOCTYPE html>
<html lang="en">
<head>
    <title>Rider App - RideLink</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e293b">
    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body { background: #f0f2f5; font-family: 'Segoe UI', sans-serif; padding-bottom: 90px; -webkit-tap-highlight-color: transparent; }
        
        /* HEADER */
        .page-header { background: #1e293b; color: white; padding: 15px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        
        /* INPUTS */
        .card { background: white; margin: 15px; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: none; }
        .input-group { margin-bottom: 15px; width: 100%; }
        .input-group label { display: block; font-size: 12px; color: #64748b; margin-bottom: 5px; font-weight: 600; text-align: left; width: 100%; }
        .input-group input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 16px; background: #fff; }
        .input-group input:focus { border-color: #10b981; outline: none; }

        /* VEHICLE GRID */
        .vehicle-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 0 15px; }
        .vehicle-item { 
            background: white; border: 2px solid #e2e8f0; border-radius: 12px; 
            padding: 15px 5px; text-align: center; cursor: pointer; transition: 0.2s; user-select: none; 
        }
        
        /* LIST ITEMS */
        .req-card { background: white; padding: 15px; border-radius: 10px; border-left: 5px solid #f59e0b; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); cursor: pointer; }
        .status-confirmed { background: #d1fae5; border-left-color: #10b981; }

        /* OVERLAY */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(30, 41, 59, 0.95); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; color: white; text-align: center; }
        .spinner { border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid #10b981; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* DETAILS */
        .bid-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <div id="view-home">
        <div class="page-header">
            <h2 style="margin:0; font-size:18px; font-weight:700;">üíé RideLink Rider</h2>
            <span onclick="logout()" style="color:white; font-size:12px; cursor:pointer;">Logout</span>
        </div>

        <div class="card">
            <div class="input-group">
                <label>Pickup Location <span style="color:red">*</span></label>
                <input type="text" id="inp-pickup" placeholder="E.g. Main Market">
            </div>
            <div class="input-group">
                <label>Dropoff Location <span style="color:red">*</span></label>
                <input type="text" id="inp-drop" placeholder="E.g. City Hospital">
            </div>
            <div class="input-group">
                <label>Landmark (Optional)</label>
                <input type="text" id="inp-landmark" placeholder="Near Park...">
            </div>
            <div class="input-group">
                <label>My Phone Number <span style="color:red">*</span></label>
                <input type="tel" id="inp-phone" placeholder="03xx-xxxxxxx">
            </div>
        </div>

        <div style="margin: 0 15px 10px; font-weight:bold; color:#475569;">Select Vehicle Type <span style="color:red">*</span></div>
        
        <div class="vehicle-grid">
            <div class="vehicle-item" id="btn-bike" onclick="selectVehicle('bike')">
                <span style="font-size:28px; display:block;">üèçÔ∏è</span>
                <span style="font-size:11px; font-weight:bold;">Bike</span>
            </div>
            <div class="vehicle-item" id="btn-rickshaw" onclick="selectVehicle('rickshaw')">
                <span style="font-size:28px; display:block;">üõ∫</span>
                <span style="font-size:11px; font-weight:bold;">Rickshaw</span>
            </div>
            <div class="vehicle-item" id="btn-car" onclick="selectVehicle('car')">
                <span style="font-size:28px; display:block;">üöó</span>
                <span style="font-size:11px; font-weight:bold;">Car</span>
            </div>
            <div class="vehicle-item" id="btn-carry" onclick="selectVehicle('carry')">
                <span style="font-size:28px; display:block;">üöê</span>
                <span style="font-size:11px; font-weight:bold;">Carry</span>
            </div>
            <div class="vehicle-item" id="btn-coaster" onclick="selectVehicle('coaster')">
                <span style="font-size:28px; display:block;">üöå</span>
                <span style="font-size:11px; font-weight:bold;">Coaster</span>
            </div>
            <div class="vehicle-item" id="btn-loader" onclick="selectVehicle('loader')">
                <span style="font-size:28px; display:block;">üöö</span>
                <span style="font-size:11px; font-weight:bold;">Loader</span>
            </div>
            <div class="vehicle-item" id="btn-luxury" onclick="selectVehicle('luxury')">
                <span style="font-size:28px; display:block;">üöò</span>
                <span style="font-size:11px; font-weight:bold;">Luxury</span>
            </div>
        </div>

        <div style="margin: 30px 15px 100px;">
            <h4 style="margin-bottom: 10px; color: #64748b; font-size: 13px; text-transform: uppercase; font-weight: bold;">My Active Requests</h4>
            <div id="my-requests-list">
                <p style="color:#94a3b8; font-size:12px; text-align: center;">Loading...</p>
            </div>
        </div>

        <div style="position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 15px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05);">
            <button onclick="startRequestProcess()" style="width: 100%; padding: 14px; border-radius: 12px; font-size: 16px; font-weight: bold; background: #1e293b; border: none; color: white;">Submit Request</button>
        </div>
    </div>

    <div id="view-details" style="display:none;">
        <div class="page-header">
            <span onclick="closeDetails()" style="font-size: 20px; cursor:pointer;">‚Üê Back</span>
            <h2 style="margin:0; font-size:18px;">Details</h2> <div></div> 
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <div>
                    <div style="font-size: 11px; color: #94a3b8; font-weight: bold;">STATUS</div>
                    <div id="disp-status" style="font-size: 16px; font-weight: 600; color: #10b981;">Loading...</div>
                </div>
                <div style="font-size:30px;">üöó</div>
            </div>
            <hr style="border-top: 1px dashed #e2e8f0;">
            
            <div style="font-size: 11px; color: #94a3b8; font-weight: bold;">ROUTE</div>
            <div id="disp-pickup" style="font-size: 15px; font-weight: 600;">...</div>
            <div style="color:#999; font-size:12px;">to</div>
            <div id="disp-drop" style="font-size: 15px; font-weight: 600;">...</div>
        </div>

        <div id="section-bids" style="display:none; padding: 0 15px;">
            <h4 style="margin:0 0 15px 0; font-size: 14px; font-weight:bold; color:#475569;">Driver Offers</h4>
            <div id="bids-list"></div>
            <p id="no-bids-msg" style="text-align:center; padding: 20px; color:#999; font-size:13px;">Waiting for drivers...</p>
        </div>

        <div id="section-confirmed" style="display:none; padding: 15px;">
            <div style="background: #ecfdf5; border: 1px solid #d1fae5; border-radius: 12px; padding: 20px; text-align: center;">
                <span style="font-size: 40px;">üöñ</span>
                <h2 style="margin:0; font-size: 20px; color:#065f46;">Driver Confirmed!</h2>
                <h3 id="driver-name-display" style="margin:5px 0; font-size:16px;">Name</h3>
                <h4 id="driver-price-display" style="margin:0; font-size: 24px; font-weight:bold; color:#059669;">Rs. 0</h4>
            </div>
        </div>

        <div id="section-pending" style="display:none; padding: 15px;">
            <button onclick="deleteCurrentRequest()" style="background: #fee2e2; color: #ef4444; border: none; padding: 15px; width: 100%; border-radius: 12px; font-weight: bold;">Cancel Request</button>
        </div>
    </div>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <h3 style="font-size:18px;">Please Wait...</h3>
        <p id="loading-text" style="font-size: 14px; margin-top: 10px; color: #cbd5e1;">Processing...</p>
        <button id="cancel-gps-btn" onclick="cancelProcess()" style="margin-top: 25px; background: transparent; border: 1px solid rgba(255,255,255,0.5); color: white; padding: 8px 25px; border-radius: 20px; font-size: 13px; display:none;">Cancel</button>
    </div>

    <script src="firebase-init.js"></script>

    <script>
        // GLOBAL STATE
        let db, auth;
        let currentUser = null;
        let currentVehicleType = null; // Stores selected type
        let activeReqRef = null;
        let activeReqId = null;

        // 1. INIT
        window.onload = function() {
            if (typeof firebase === 'undefined') return alert("Firebase SDK Error");
            db = firebase.database();
            auth = firebase.auth();

            auth.onAuthStateChanged(user => {
                if (user) {
                    console.log("Logged in:", user.uid);
                    currentUser = { id: user.uid, phone: user.phoneNumber || '' };
                    
                    // Pre-fill phone if not empty
                    if(currentUser.phone && !document.getElementById('inp-phone').value) {
                        document.getElementById('inp-phone').value = currentUser.phone;
                    }
                    listenForMyRequests();
                } else {
                    window.location.href = "index.html";
                }
            });
        };

        // 2. ROBUST VEHICLE SELECTION
        window.selectVehicle = function(type) {
            currentVehicleType = type;
            // Clear styles for all
            const items = document.querySelectorAll('.vehicle-item');
            items.forEach(el => {
                el.style.border = "2px solid #e2e8f0";
                el.style.backgroundColor = "white";
                el.style.transform = "scale(1)";
            });

            // Set style for selected (using ID)
            const active = document.getElementById('btn-' + type);
            if(active) {
                active.style.border = "2px solid #10b981"; // Green Border
                active.style.backgroundColor = "#d1fae5"; // Light Green BG
                active.style.transform = "scale(1.05)";
            }
        };

        // 3. LISTEN FOR REQUESTS
        function listenForMyRequests() {
            if (!currentUser) return;
            const list = document.getElementById('my-requests-list');

            db.ref('requests').orderByChild('riderId').equalTo(currentUser.id).on('value', snap => {
                list.innerHTML = '';
                if (!snap.exists()) {
                    list.innerHTML = '<p style="color:#94a3b8; text-align: center; margin-top:20px;">No active requests.</p>';
                    return;
                }
                
                const reqs = [];
                snap.forEach(c => reqs.push({ k: c.key, v: c.val() }));
                reqs.reverse();

                reqs.forEach(item => {
                    const r = item.v;
                    if(r.status === 'cancelled' || r.status === 'deleted') return;
                    
                    const div = document.createElement('div');
                    div.className = 'req-card';
                    if(r.status === 'confirmed') div.classList.add('status-confirmed');
                    div.onclick = () => openDetails(item.k);
                    
                    div.innerHTML = `
                        <span style="float:right; font-size:10px; background:#fef3c7; padding:2px 5px;">${(r.status||'').toUpperCase()}</span>
                        <strong>${r.drop}</strong><br>
                        <small style="color:#666">Pickup: ${r.pickup}</small>
                    `;
                    list.appendChild(div);
                });
            });
        }

        // 4. SUBMIT WITH STRICT GPS
        window.startRequestProcess = function() {
            // Validate Vehicle
            if (!currentVehicleType) {
                alert("‚ö†Ô∏è Please select a Vehicle Type (tap an icon).");
                return;
            }
            
            const pickup = document.getElementById('inp-pickup').value;
            const drop = document.getElementById('inp-drop').value;
            const phone = document.getElementById('inp-phone').value;
            const landmark = document.getElementById('inp-landmark').value;

            if (!pickup || !drop) return alert("Please enter Pickup and Drop locations.");
            if (!phone) return alert("Please enter your Phone Number.");

            // Start GPS Process
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-text').innerText = "Locating GPS Satellites...";
            document.getElementById('cancel-gps-btn').style.display = 'block';

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        // SUCCESS
                        submitData(pos.coords.latitude, pos.coords.longitude, pickup, drop, landmark, phone);
                    },
                    (err) => {
                        // FAIL
                        document.getElementById('loading-overlay').style.display = 'none';
                        if(err.code === 1) alert("Permission Denied. Enable Location.");
                        else alert("‚ö†Ô∏è Weak GPS Signal!\n\nPlease go outdoors to get a clear signal. We cannot book a ride without your exact location.");
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                alert("GPS not supported.");
                document.getElementById('loading-overlay').style.display = 'none';
            }
        };

        window.cancelProcess = function() {
            document.getElementById('loading-overlay').style.display = 'none';
        };

        function submitData(lat, lng, pickup, drop, landmark, phone) {
            document.getElementById('loading-text').innerText = "Sending...";
            document.getElementById('cancel-gps-btn').style.display = 'none';

            const data = {
                riderId: currentUser.id,
                riderPhone: phone,
                pickup: pickup, drop: drop, landmark: landmark,
                vehicleType: currentVehicleType,
                lat: lat, lng: lng,
                status: 'pending',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            db.ref('requests').push(data).then(() => {
                document.getElementById('loading-overlay').style.display = 'none';
                alert("‚úÖ Request Sent!");
                // Clear form
                document.getElementById('inp-pickup').value = "";
                document.getElementById('inp-drop').value = "";
                document.getElementById('inp-landmark').value = "";
                // Reset Selection
                currentVehicleType = null;
                document.querySelectorAll('.vehicle-item').forEach(el => {
                    el.style.border = "2px solid #e2e8f0";
                    el.style.backgroundColor = "white";
                    el.style.transform = "scale(1)";
                });
            });
        }

        // 5. DETAILS
        window.openDetails = function(key) {
            activeReqId = key;
            document.getElementById('view-home').style.display = 'none';
            document.getElementById('view-details').style.display = 'block';

            if(activeReqRef) activeReqRef.off();
            activeReqRef = db.ref('requests/' + key);
            
            activeReqRef.on('value', snap => {
                if(!snap.exists()) { alert("Request deleted"); closeDetails(); return; }
                const d = snap.val();

                document.getElementById('disp-status').innerText = (d.status||'').toUpperCase();
                document.getElementById('disp-pickup').innerText = d.pickup;
                document.getElementById('disp-drop').innerText = d.drop;

                // Toggle Sections
                const secBids = document.getElementById('section-bids');
                const secConf = document.getElementById('section-confirmed');
                const secPend = document.getElementById('section-pending');

                if(d.status === 'confirmed') {
                    secBids.style.display = 'none';
                    secPend.style.display = 'none';
                    secConf.style.display = 'block';
                    document.getElementById('driver-name-display').innerText = d.selectedDriverName;
                    document.getElementById('driver-price-display').innerText = "Rs. " + d.agreedPrice;
                } else {
                    secConf.style.display = 'none';
                    secPend.style.display = 'block';
                    secBids.style.display = 'block';
                    
                    // Render Bids
                    const list = document.getElementById('bids-list');
                    list.innerHTML = '';
                    if(d.bids) {
                        document.getElementById('no-bids-msg').style.display = 'none';
                        Object.keys(d.bids).forEach(k => {
                            const bid = d.bids[k];
                            // Correct Plate Logic
                            const plate = bid.vehiclePlate || bid.plateNumber || '---';
                            
                            const div = document.createElement('div');
                            div.className = 'bid-card';
                            div.innerHTML = `
                                <div><strong>${bid.driverName}</strong><br><small>${bid.vehicleModel} (${plate})</small></div>
                                <div style="text-align:right">
                                    <div style="font-weight:bold; color:#10b981; font-size:18px;">Rs ${bid.price}</div>
                                    <button onclick="acceptBid('${key}','${k}','${bid.driverName}',${bid.price})" style="background:#10b981; color:white; border:none; padding:5px 10px; border-radius:5px; font-weight:bold; margin-top:5px;">Accept</button>
                                </div>
                            `;
                            list.appendChild(div);
                        });
                    } else {
                        document.getElementById('no-bids-msg').style.display = 'block';
                    }
                }
            });
        };

        window.acceptBid = function(reqId, drvId, drvName, price) {
            if(confirm("Accept ride for Rs " + price + "?")) {
                db.ref('requests/' + reqId).update({
                    status: 'confirmed',
                    selectedDriverId: drvId,
                    selectedDriverName: drvName,
                    agreedPrice: price
                });
            }
        };

        window.closeDetails = function() {
            if(activeReqRef) activeReqRef.off();
            document.getElementById('view-details').style.display = 'none';
            document.getElementById('view-home').style.display = 'block';
        };

        window.deleteCurrentRequest = function() {
            if(confirm("Cancel Request?")) {
                db.ref('requests/' + activeReqId).update({status: 'cancelled'}).then(() => closeDetails());
            }
        };

        window.logout = function() { auth.signOut().then(() => window.location.href="index.html"); };
    </script>
</body>
</html>
