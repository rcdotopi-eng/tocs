<!DOCTYPE html>
<html lang="en">
<head>
    <title>Rider App - RideLink</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e293b">
    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body { background: #f0f2f5; font-family: 'Segoe UI', sans-serif; padding-bottom: 80px; -webkit-tap-highlight-color: transparent; }
        
        /* HEADER */
        .page-header {
            background: #1e293b; color: white; padding: 15px 20px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 100;
        }
        .page-header h2 { margin: 0; font-size: 18px; font-weight: 700; }
        .action-btn { color: #fff; font-size: 13px; cursor: pointer; opacity: 0.8; }

        /* CARDS */
        .card { background: white; margin: 15px; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: none; }
        
        /* INPUTS */
        .input-group { margin-bottom: 15px; width: 100%; }
        .input-group label { display: block; font-size: 12px; color: #64748b; margin-bottom: 5px; font-weight: 600; text-align: left; width: 100%; }
        .input-group input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 16px; background: #f8fafc; transition: 0.3s; }
        .input-group input:focus { border-color: #10b981; outline: none; background: #fff; }

        /* VEHICLE GRID */
        .grid-title { margin: 0 15px 10px; font-size: 14px; font-weight: bold; color: #475569; }
        .vehicle-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 0 15px; }
        .vehicle-item { background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 10px 5px; text-align: center; cursor: pointer; transition: 0.2s; user-select: none; }
        .vehicle-item.selected { border-color: #10b981; background-color: #ecfdf5; transform: scale(1.02); box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2); }
        .v-icon { font-size: 28px; display: block; margin-bottom: 5px; }
        .v-name { font-size: 11px; font-weight: 600; color: #334155; }

        /* REQUEST LIST ITEM */
        .req-card { 
            background: white; padding: 15px; border-radius: 10px; border-left: 5px solid #f59e0b; 
            margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); position: relative; cursor: pointer; 
        }
        .req-arrow { position: absolute; right: 15px; top: 35%; color: #cbd5e1; font-size: 20px; }
        .req-status { float: right; font-size: 10px; font-weight: 800; background: #fef3c7; color: #d97706; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-confirmed { background: #d1fae5; color: #059669; border-left-color: #10b981; }

        /* DETAILS VIEW */
        .detail-row { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .label { font-size: 11px; color: #94a3b8; text-transform: uppercase; font-weight: bold; }
        .val { font-size: 16px; color: #1e293b; font-weight: 600; }
        
        .driver-box { background: #ecfdf5; border: 1px solid #d1fae5; border-radius: 12px; padding: 20px; text-align: center; color: #065f46; margin-top: 15px; }
        
        /* BIDS */
        .bid-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .bid-price { font-size: 18px; font-weight: bold; color: #10b981; }
        .btn-confirm { background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: bold; }
        .btn-cancel { background: #fee2e2; color: #ef4444; border: none; padding: 15px; width: 100%; border-radius: 12px; font-weight: bold; margin-top: 20px; }

        /* BOTTOM BAR & OVERLAY */
        .bottom-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 15px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 100; }
        .btn-primary { width: 100%; padding: 14px; border-radius: 12px; font-size: 16px; font-weight: bold; background: #1e293b; border: none; color: white; }
        
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(30, 41, 59, 0.9); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; color: white; text-align: center; }
        .spinner { border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid #10b981; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="view-home">
        <div class="page-header">
            <h2>üíé RideLink Rider</h2>
            <a class="action-btn" onclick="logout()">Logout</a>
        </div>

        <div class="card">
            <div class="input-group">
                <label>Pickup Location <span style="color:red">*</span></label>
                <input type="text" id="inp-pickup" placeholder="E.g. Main Market">
            </div>
            <div class="input-group">
                <label>Dropoff Location <span style="color:red">*</span></label>
                <input type="text" id="inp-drop" placeholder="E.g. City Hospital">
            </div>
            <div class="input-group">
                <label>Landmark (Optional)</label>
                <input type="text" id="inp-landmark" placeholder="Near Masjid, Park...">
            </div>
            <div class="input-group">
                <label>Contact Number <span style="color:red">*</span></label>
                <input type="tel" id="inp-phone" readonly style="background-color: #f1f5f9; color: #64748b;">
            </div>
        </div>

        <div class="grid-title">Select Vehicle</div>
        <div class="vehicle-grid">
            <div class="vehicle-item" id="v-bike" onclick="selectVehicle('bike', 'v-bike')"><span class="v-icon">üèçÔ∏è</span><span class="v-name">Bike</span></div>
            <div class="vehicle-item" id="v-rickshaw" onclick="selectVehicle('rickshaw', 'v-rickshaw')"><span class="v-icon">üõ∫</span><span class="v-name">Rickshaw</span></div>
            <div class="vehicle-item" id="v-car" onclick="selectVehicle('car', 'v-car')"><span class="v-icon">üöó</span><span class="v-name">Car</span></div>
            <div class="vehicle-item" id="v-carry" onclick="selectVehicle('carry', 'v-carry')"><span class="v-icon">üöê</span><span class="v-name">Carry</span></div>
            <div class="vehicle-item" id="v-coaster" onclick="selectVehicle('coaster', 'v-coaster')"><span class="v-icon">üöå</span><span class="v-name">Coaster</span></div>
            <div class="vehicle-item" id="v-loader" onclick="selectVehicle('loader', 'v-loader')"><span class="v-icon">üöö</span><span class="v-name">Loader</span></div>
            <div class="vehicle-item" id="v-luxury" onclick="selectVehicle('luxury', 'v-luxury')"><span class="v-icon">üöò</span><span class="v-name">Luxury</span></div>
        </div>

        <div style="margin: 30px 15px 100px;">
            <h4 style="margin-bottom: 10px; color: #64748b; font-size: 13px; text-transform: uppercase; font-weight: bold; letter-spacing: 1px;">My Active Requests</h4>
            <div id="my-requests-list">
                <p style="color:#94a3b8; font-size:12px; text-align: center;">Connecting to network...</p>
            </div>
        </div>

        <div class="bottom-bar">
            <button class="btn-primary" onclick="startRequestProcess()">Submit Request</button>
        </div>
    </div>

    <div id="view-details" style="display:none;">
        <div class="page-header">
            <a class="action-btn" style="font-size: 20px; text-decoration: none;" onclick="closeDetails()">‚Üê Back</a>
            <h2>Ride Details</h2> <div></div> 
        </div>

        <div class="card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="label" style="margin-top:0;">Status</div>
                    <div class="val" id="disp-status" style="color: #10b981;">Loading...</div>
                </div>
                <div style="font-size:30px;" id="disp-icon">üöó</div>
            </div>
            <hr style="border: 0; border-top: 1px dashed #e2e8f0; margin: 15px 0;">
            
            <div class="label">Pickup</div>
            <div class="val" id="disp-pickup">...</div>
            
            <div style="height: 15px; border-left: 2px dashed #cbd5e1; margin-left: 8px; margin-top:5px; margin-bottom:5px;"></div>
            
            <div class="label">Dropoff</div>
            <div class="val" id="disp-drop">...</div>

            <div class="label" style="margin-top: 15px;">Vehicle</div>
            <div class="val" id="disp-vehicle">...</div>
        </div>

        <div id="section-bids" style="display:none; padding: 0 15px;">
            <h4 style="margin:0 0 15px 0; font-size: 14px; font-weight:bold; color:#475569;">Driver Offers</h4>
            <div id="bids-list"></div>
            <p id="no-bids-msg" style="font-size:13px; color:#94a3b8; text-align:center; padding: 20px; background:white; border-radius:12px;">Waiting for drivers to offer prices...</p>
        </div>

        <div id="section-confirmed" style="display:none; padding: 15px;">
            <div class="driver-box">
                <span style="font-size: 40px; display:block; margin-bottom:10px;">üöñ</span>
                <h2 style="margin:0; font-size: 20px; color:#065f46;">Driver Confirmed!</h2>
                <p style="font-size: 13px; margin-bottom: 0;">Your ride is on the way.</p>
                <hr style="border-top:1px solid #a7f3d0; margin:15px 0;">
                <h3 id="driver-name-display" style="margin:5px 0;">Driver Name</h3>
                <h4 id="driver-price-display" style="margin:0; color: #059669; font-size: 24px;">Rs. 0</h4>
            </div>
        </div>

        <div id="section-pending" style="display:none; padding: 15px;">
            <button class="btn-cancel" onclick="deleteCurrentRequest()">Cancel Request</button>
        </div>
    </div>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <h3 style="font-size:18px;">Please Wait...</h3>
        <p id="loading-text" style="font-size: 14px; margin-top: 10px; color: #cbd5e1;">Initializing...</p>
        <button onclick="cancelProcess()" style="margin-top: 25px; background: transparent; border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 25px; border-radius: 20px; font-size: 13px;">Cancel</button>
    </div>

    <script src="firebase-init.js"></script>

    <script>
        // GLOBAL STATE
        let currentUserData = null; // Stores {id, name, phone}
        let selectedVehicleType = null;
        let isProcessing = false;
        let activeRequestRef = null; 
        let activeRequestId = null;

        // 1. APP STARTUP
        window.onload = function() {
            // Check if Firebase loaded
            if (typeof firebase === 'undefined') {
                alert("Error: Firebase not loaded. Check firebase-init.js");
                return;
            }

            // Listen for Auth State
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    // USER LOGGED IN
                    console.log("‚úÖ User Logged In:", user.uid);
                    
                    // Construct User Object
                    currentUserData = {
                        id: user.uid,
                        name: user.displayName || 'Rider',
                        phone: user.phoneNumber || ''
                    };

                    // Fill Phone Field
                    document.getElementById('inp-phone').value = currentUserData.phone;

                    // Load Data
                    loadMyRequests();
                } else {
                    // NO USER -> REDIRECT LOGIN
                    console.log("‚õî No User. Redirecting...");
                    window.location.href = "index.html";
                }
            });
        };

        // 2. UI FUNCTIONS
        function selectVehicle(type, elementId) {
            selectedVehicleType = type;
            // Remove 'selected' class from all, add to clicked
            document.querySelectorAll('.vehicle-item').forEach(el => el.classList.remove('selected'));
            document.getElementById(elementId).classList.add('selected');
        }

        function showLoading(msg) {
            document.getElementById('loading-text').innerText = msg;
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        function cancelProcess() {
            isProcessing = false;
            hideLoading();
        }

        // 3. REQUEST SUBMISSION LOGIC
        function startRequestProcess() {
            if (!navigator.onLine) return alert("No Internet Connection.");
            if (!currentUserData || !currentUserData.id) return alert("Please wait for login to finish.");
            
            const pickup = document.getElementById('inp-pickup').value.trim();
            const drop = document.getElementById('inp-drop').value.trim();
            const landmark = document.getElementById('inp-landmark').value.trim();

            if (!pickup || !drop) return alert("Please enter Pickup and Drop locations.");
            if (!selectedVehicleType) return alert("Please select a Vehicle Type.");

            isProcessing = true;
            showLoading("üõ∞Ô∏è Getting GPS Location...");

            // Get GPS
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        if (!isProcessing) return;
                        submitToFirebase(pos.coords.latitude, pos.coords.longitude, pickup, drop, landmark);
                    },
                    (err) => {
                        if (!isProcessing) return;
                        // Fallback if GPS fails
                        if(confirm("GPS failed. Send request anyway?")) {
                            submitToFirebase(0, 0, pickup, drop, landmark);
                        } else {
                            cancelProcess();
                        }
                    },
                    { timeout: 10000, enableHighAccuracy: true }
                );
            } else {
                submitToFirebase(0, 0, pickup, drop, landmark);
            }
        }

        function submitToFirebase(lat, lng, pickup, drop, landmark) {
            showLoading("üì§ Sending Request...");

            const newReq = {
                riderId: currentUserData.id,
                riderName: currentUserData.name,
                riderPhone: currentUserData.phone,
                pickup: pickup,
                drop: drop,
                landmark: landmark,
                vehicleType: selectedVehicleType,
                lat: lat,
                lng: lng,
                status: 'pending',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            firebase.database().ref('requests').push(newReq)
                .then(() => {
                    isProcessing = false;
                    hideLoading();
                    alert("‚úÖ Request Sent!");
                    
                    // Clear inputs
                    document.getElementById('inp-pickup').value = "";
                    document.getElementById('inp-drop').value = "";
                    document.getElementById('inp-landmark').value = "";
                    selectedVehicleType = null;
                    document.querySelectorAll('.vehicle-item').forEach(el => el.classList.remove('selected'));
                })
                .catch(err => {
                    isProcessing = false;
                    hideLoading();
                    alert("Error: " + err.message);
                });
        }

        // 4. LOAD ACTIVE REQUESTS
        function loadMyRequests() {
            if(!currentUserData) return;

            const ref = firebase.database().ref('requests');
            // Query: requests where riderId == currentUserId
            ref.orderByChild('riderId').equalTo(currentUserData.id).on('value', snap => {
                const list = document.getElementById('my-requests-list');
                list.innerHTML = ""; // Clear list

                if (!snap.exists()) {
                    list.innerHTML = '<p style="color:#94a3b8; text-align: center; margin-top:20px;">No active requests.</p>';
                    return;
                }

                const requests = [];
                snap.forEach(child => {
                    requests.push({ key: child.key, val: child.val() });
                });

                // Show newest first
                requests.reverse();

                let count = 0;
                requests.forEach(item => {
                    const r = item.val;
                    // Skip old/cancelled stuff if you want, or show history
                    if (r.status === 'cancelled' || r.status === 'deleted') return;

                    count++;
                    const div = document.createElement('div');
                    div.className = 'req-card';
                    if (r.status === 'confirmed') div.classList.add('status-confirmed');
                    
                    div.onclick = () => openDetails(item.key);

                    div.innerHTML = `
                        <span class="req-status">${r.status}</span>
                        <span class="req-arrow">‚ùØ</span>
                        <div style="font-weight:bold; color:#1e293b;">${r.drop}</div>
                        <div style="font-size:12px; color:#64748b;">From: ${r.pickup}</div>
                        <div style="font-size:11px; color:#94a3b8; margin-top:4px;">${r.vehicleType.toUpperCase()}</div>
                    `;
                    list.appendChild(div);
                });

                if (count === 0) list.innerHTML = '<p style="color:#94a3b8; text-align: center; margin-top:20px;">No active requests.</p>';
            });
        }

        // 5. DETAILS & BID LOGIC
        function openDetails(reqId) {
            activeRequestId = reqId;
            
            // Switch Views
            document.getElementById('view-home').style.display = 'none';
            document.getElementById('view-details').style.display = 'block';
            window.scrollTo(0,0);

            // Listen to this specific request
            if(activeRequestRef) activeRequestRef.off(); // Detach old listener
            activeRequestRef = firebase.database().ref('requests/' + reqId);

            activeRequestRef.on('value', snap => {
                if(!snap.exists()) {
                    alert("This request was deleted.");
                    closeDetails();
                    return;
                }
                const data = snap.val();
                renderDetails(data, reqId);
            });
        }

        function closeDetails() {
            if(activeRequestRef) activeRequestRef.off();
            activeRequestId = null;
            document.getElementById('view-details').style.display = 'none';
            document.getElementById('view-home').style.display = 'block';
        }

        function renderDetails(data, reqId) {
            // Basic Info
            document.getElementById('disp-status').innerText = data.status.toUpperCase();
            document.getElementById('disp-pickup').innerText = data.pickup;
            document.getElementById('disp-drop').innerText = data.drop;
            document.getElementById('disp-vehicle').innerText = data.vehicleType;

            const bidsList = document.getElementById('bids-list');
            const bidsSection = document.getElementById('section-bids');
            const pendingSection = document.getElementById('section-pending');
            const confirmedSection = document.getElementById('section-confirmed');

            // STATE: CONFIRMED
            if (data.status === 'confirmed') {
                pendingSection.style.display = 'none';
                bidsSection.style.display = 'none';
                confirmedSection.style.display = 'block';
                
                document.getElementById('driver-name-display').innerText = data.selectedDriverName || "Driver";
                document.getElementById('driver-price-display').innerText = "Rs. " + data.agreedPrice;
            } 
            // STATE: PENDING (Waiting for bids)
            else {
                confirmedSection.style.display = 'none';
                pendingSection.style.display = 'block';
                bidsSection.style.display = 'block';

                // Render Bids
                bidsList.innerHTML = '';
                if (data.bids) {
                    document.getElementById('no-bids-msg').style.display = 'none';
                    Object.keys(data.bids).forEach(key => {
                        const bid = data.bids[key];
                        const div = document.createElement('div');
                        div.className = 'bid-card';
                        div.innerHTML = `
                            <div>
                                <div style="font-weight:bold; color:#334155;">${bid.driverName}</div>
                                <div style="font-size:12px; color:#64748b;">${bid.vehicleModel} (${bid.plateNumber})</div>
                            </div>
                            <div style="text-align:right;">
                                <div class="bid-price">Rs. ${bid.price}</div>
                                <button class="btn-confirm" onclick="acceptBid('${reqId}', '${key}', '${bid.driverName}', ${bid.price})">Accept</button>
                            </div>
                        `;
                        bidsList.appendChild(div);
                    });
                } else {
                    document.getElementById('no-bids-msg').style.display = 'block';
                }
            }
        }

        function acceptBid(reqId, driverId, driverName, price) {
            if(!confirm(`Accept ride for Rs. ${price}?`)) return;

            firebase.database().ref('requests/' + reqId).update({
                status: 'confirmed',
                selectedDriverId: driverId,
                selectedDriverName: driverName,
                agreedPrice: price
            });
        }

        function deleteCurrentRequest() {
            if(!confirm("Are you sure you want to cancel?")) return;
            
            // We can either remove it or set status to 'cancelled'
            firebase.database().ref('requests/' + activeRequestId).update({
                status: 'cancelled'
            }).then(() => {
                closeDetails();
            });
        }

        function logout() {
            firebase.auth().signOut().then(() => {
                window.location.href = "index.html";
            });
        }
    </script>
</body>
</html>
