<!DOCTYPE html>
<html lang="en">
<head>
    <title>Driver App - RideLink</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#28a745">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body { background: #f0f2f5; font-family: 'Segoe UI', sans-serif; padding-bottom: 90px; }
        .page-header { background: #28a745; color: white; padding: 15px 20px; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:100; }
        .req-card { background:white; margin:15px; padding:15px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.05); border-left:5px solid #ffc107; }
        .req-header { display:flex; justify-content:space-between; margin-bottom:10px; }
        .badge-vehicle { background:#e9ecef; padding:3px 8px; border-radius:4px; font-size:11px; font-weight:bold; }
        .bid-controls { display:flex; gap:10px; margin-top:10px; }
        .bid-input { width:60%; padding:10px; border:1px solid #ced4da; border-radius:8px; }
        .btn-bid { width:40%; background:#28a745; color:white; border:none; border-radius:8px; font-weight:bold; }
        .btn-map { display:block; width:100%; background:#e3f2fd; color:#007bff; border:1px solid #b6d4fe; padding:8px; border-radius:8px; margin-bottom:10px; font-weight:bold; text-decoration:none; }
        .bottom-nav { position:fixed; bottom:0; left:0; width:100%; background:white; padding:15px; display:flex; justify-content:space-around; box-shadow:0 -2px 10px rgba(0,0,0,0.1); }
        .nav-item { font-size:12px; color:#999; cursor:pointer; text-align:center; }
        .nav-item.active { color:#28a745; font-weight:bold; }
        .gps-status { font-size:10px; background:rgba(0,0,0,0.1); padding:4px 8px; border-radius:20px; }
        .btn-action { width:100%; margin-top:5px; font-size:14px; padding:10px; border-radius:8px; border:none; color:white; }
    </style>
</head>
<body>

<div class="page-header">
    <div>
        <h2 style="margin:0;font-size:18px;font-weight:700;">ðŸš– Driver Panel</h2>
        <span id="gps-indicator" class="gps-status">ðŸ“¡ GPS: Initializing...</span>
    </div>
    <span onclick="logout()" style="cursor:pointer;font-size:12px;">Logout</span>
</div>

<div id="tab-new" class="container mt-3">
    <h6 class="text-muted">JOBS NEARBY (5KM)</h6>
    <div id="new-requests-list"><p class="text-center">Waiting for GPSâ€¦</p></div>
</div>

<div id="tab-my" class="container mt-3" style="display:none;">
    <h6 class="text-muted">MY ACTIVE RIDES</h6>
    <div id="my-rides-list"></div>
</div>

<div id="tab-history" class="container mt-3" style="display:none;">
    <h6 class="text-muted">COMPLETED RIDES</h6>
    <div id="history-list"></div>
</div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('new')">ðŸ“¡<br>New</div>
    <div class="nav-item" onclick="switchTab('my')">âœ…<br>Active</div>
    <div class="nav-item" onclick="switchTab('history')">ðŸ“œ<br>History</div>
</div>

<script src="firebase-init.js"></script>
<script>
if (typeof db === 'undefined') db = firebase.database();
if (typeof auth === 'undefined') auth = firebase.auth();

let driverUser = null;
let myLat = 0, myLng = 0;

auth.onAuthStateChanged(user => {
    if (!user) return window.location.href = "index.html";

    db.ref('users/' + user.uid).once('value').then(snap => {
        if (!snap.exists()) return logout();
        driverUser = snap.val();
        driverUser.id = user.uid;
        startGpsTracking();
        listenForRequests();
    });
});

function startGpsTracking() {
    updateLocation();
    setInterval(updateLocation, 30000);
}

function updateLocation() {
    navigator.geolocation.getCurrentPosition(pos => {
        myLat = pos.coords.latitude;
        myLng = pos.coords.longitude;
        document.getElementById('gps-indicator').innerText = "ðŸ“¡ GPS: Active";
        db.ref('users/' + driverUser.id + '/location').update({ lat: myLat, lng: myLng, ts: Date.now() });
        listenForRequests();
    });
}

function getDistance(a,b,c,d){
    const R=6371;
    const dLat=(c-a)*Math.PI/180;
    const dLon=(d-b)*Math.PI/180;
    const x=Math.sin(dLat/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

function listenForRequests() {
    db.ref('requests').off();
    db.ref('requests').on('value', snap => {
        const newList = document.getElementById('new-requests-list');
        const myList = document.getElementById('my-rides-list');
        const hist = document.getElementById('history-list');
        newList.innerHTML = myList.innerHTML = hist.innerHTML = '';

        snap.forEach(c => {
            const r = c.val(), id = c.key;

            if (r.status === 'CONFIRMED' && r.selectedDriverId === driverUser.id) {
                myList.innerHTML += `<div class="req-card"><strong>${r.drop}</strong><br>Rs. ${r.agreedPrice}</div>`;
                return;
            }

            if (r.status === 'COMPLETED' && r.selectedDriverId === driverUser.id) {
                hist.innerHTML += `<div class="req-card">${r.drop} - Rs. ${r.agreedPrice}</div>`;
                return;
            }

            if (['pending','OFFERS_RECEIVED'].includes(r.status)) {
                if (r.vehicleType && driverUser.vehicleType &&
                    r.vehicleType.toLowerCase() !== driverUser.vehicleType.toLowerCase()) return;

                if (!myLat || !myLng) return;
                const d = getDistance(myLat,myLng,r.lat,r.lng);
                if (d > 5) return;

                const bid = r.bids && r.bids[driverUser.id];
                newList.innerHTML += `
                    <div class="req-card">
                        <strong>${r.drop}</strong> (${d.toFixed(1)}km)<br>
                        ${bid ? 'You bid Rs.'+bid.price :
                        `<input id="p-${id}" class="bid-input"><button onclick="sendOffer('${id}')">Bid</button>`}
                    </div>`;
            }
        });
    });
}

function sendOffer(id) {
    const price = document.getElementById('p-'+id).value;
    if (!price) return;
    db.ref('requests/'+id+'/bids/'+driverUser.id).set({
        driverId:driverUser.id, driverName:driverUser.name,
        vehicleModel:driverUser.vehicleType, price
    });
    db.ref('requests/'+id).update({status:'OFFERS_RECEIVED'});
}

function switchTab(t){
    ['new','my','history'].forEach(x=>{
        document.getElementById('tab-'+x).style.display = x===t?'block':'none';
    });
}

function logout(){
    auth.signOut();
    window.location.href="index.html";
}
</script>
</body>
</html>
