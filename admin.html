<!DOCTYPE html>
<html lang="en">
<head>
    <title>Super Admin - RideLink GEM</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body { background:#f0f2f5; font-family:'Segoe UI',sans-serif; }
        .admin-header { background:#1e293b; color:#fff; padding:15px 25px; display:flex; justify-content:space-between; }
        .card { border:none; border-radius:12px; box-shadow:0 4px 6px rgba(0,0,0,.05); }
        .badge-active { background:#10b981; color:#fff; padding:5px 10px; border-radius:20px; font-size:11px; }
        .badge-pending { background:#f59e0b; color:#fff; padding:5px 10px; border-radius:20px; font-size:11px; }
        .badge-blocked { background:#ef4444; color:#fff; padding:5px 10px; border-radius:20px; font-size:11px; }
        .stat { font-size:28px; font-weight:700; }
        .nav-link { cursor:pointer; }
    </style>
</head>
<body>

<!-- LOGIN -->
<div id="admin-login" class="container text-center" style="margin-top:100px;">
    <div class="card p-4 mx-auto" style="max-width:400px;">
        <h4>ðŸ’Ž RideLink Admin</h4>
        <button class="btn btn-dark btn-block mt-3" onclick="adminLogin()">Sign in with Google</button>
        <p id="error-msg" class="text-danger mt-3"></p>
    </div>
</div>

<!-- DASHBOARD -->
<div id="admin-dashboard" style="display:none;">
    <div class="admin-header">
        <h5>ðŸ’Ž Control Center</h5>
        <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
    </div>

    <div class="container mt-4">

        <!-- STATS -->
        <div class="row text-center">
            <div class="col-md-3"><div class="card p-3"><small>Drivers</small><div class="stat" id="stat-drivers">0</div></div></div>
            <div class="col-md-3"><div class="card p-3"><small>Riders</small><div class="stat" id="stat-riders">0</div></div></div>
            <div class="col-md-3"><div class="card p-3"><small>Pending</small><div class="stat" id="stat-pending">0</div></div></div>
            <div class="col-md-3"><div class="card p-3"><small>Total Wallet</small><div class="stat" id="stat-wallet">0</div></div></div>
        </div>

        <!-- TABS -->
        <div class="card mt-4">
            <div class="card-header bg-white">
                <ul class="nav nav-tabs">
                    <li class="nav-item"><a class="nav-link active" onclick="switchTab('drivers', this)">ðŸš– Drivers</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="switchTab('riders', this)">ðŸš¶ Riders</a></li>
                </ul>
            </div>

            <div class="card-body p-0">
                <table class="table mb-0 table-hover">
                    <thead class="bg-light">
                        <tr>
                            <th>Name</th>
                            <th>Details</th>
                            <th>Wallet</th>
                            <th>Status</th>
                            <th class="text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<script src="firebase-init.js"></script>
<script>
/* ---------- SAFETY ---------- */
if (typeof auth === 'undefined') auth = firebase.auth();
if (typeof db === 'undefined') db = firebase.database();

/* ---------- CONFIG ---------- */
const ADMIN_EMAILS = ["rcdotopi@gmail.com"];
let currentTab = 'drivers';
let USERS = {};

/* ---------- AUTH ---------- */
window.adminLogin = function () {
    auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
};

window.logout = function () {
    auth.signOut().then(() => location.reload());
};

auth.onAuthStateChanged(user => {
    if (user && ADMIN_EMAILS.includes(user.email)) {
        document.getElementById('admin-login').style.display = 'none';
        document.getElementById('admin-dashboard').style.display = 'block';
        loadUsers();
    } else {
        document.getElementById('admin-login').style.display = 'block';
        document.getElementById('admin-dashboard').style.display = 'none';
        if (user) document.getElementById('error-msg').innerText = "Access denied";
    }
});

/* ---------- DATA ---------- */
function loadUsers() {
    db.ref('users').on('value', snap => {
        USERS = snap.val() || {};
        updateStats();
        renderTable();
    });
}

/* ---------- UI ---------- */
window.switchTab = function(tab, el) {
    currentTab = tab;
    document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
    el.classList.add('active');
    renderTable();
};

function renderTable() {
    const tbody = document.getElementById('table-body');
    tbody.innerHTML = '';

    Object.entries(USERS).forEach(([uid, u]) => {
        if (!u.role) return;

        if (currentTab === 'drivers' && u.role !== 'driver') return;
        if (currentTab === 'riders' && u.role !== 'rider') return;

        const status = u.driverStatus || u.riderStatus || 'pending';
        const badge =
            status === 'active' ? 'badge-active' :
            status === 'blocked' ? 'badge-blocked' : 'badge-pending';

        const details = u.role === 'driver'
            ? `Vehicle: ${u.vehicleType || '-'}<br>Plate: ${u.vehiclePlate || '-'}`
            : `Phone: ${u.phone || '-'}`;

        tbody.innerHTML += `
            <tr>
                <td><strong>${u.name || 'N/A'}</strong><br><small>${u.email || ''}</small></td>
                <td>${details}</td>
                <td>â‚¹ ${u.wallet || 0}</td>
                <td><span class="${badge}">${status.toUpperCase()}</span></td>
                <td class="text-right">
                    <button class="btn btn-sm btn-outline-danger" onclick="blockUser('${uid}')">ðŸš«</button>
                    <button class="btn btn-sm btn-outline-dark" onclick="deleteUser('${uid}')">ðŸ—‘</button>
                </td>
            </tr>`;
    });
}

/* ---------- STATS ---------- */
function updateStats() {
    let d=0,r=0,p=0,w=0;
    Object.values(USERS).forEach(u=>{
        if(u.role==='driver') d++;
        if(u.role==='rider') r++;
        if((u.driverStatus||u.riderStatus)==='pending') p++;
        w+=u.wallet||0;
    });
    stat-drivers.innerText=d;
    stat-riders.innerText=r;
    stat-pending.innerText=p;
    stat-wallet.innerText=w;
}

/* ---------- ACTIONS ---------- */
window.blockUser = uid => {
    if(confirm("Block user?"))
        db.ref(`users/${uid}`).update({ driverStatus:'blocked', riderStatus:'blocked' });
};

window.deleteUser = uid => {
    if(confirm("Delete user permanently?"))
        db.ref(`users/${uid}`).remove();
};
</script>
</body>
</html>
