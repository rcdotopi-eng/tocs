<!DOCTYPE html>
<html lang="en">
<head>
    <title>Super Admin - RideLink GEM</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body { background:#f0f2f5; font-family:'Segoe UI',sans-serif; }
        .admin-header { background:#1e293b; color:#fff; padding:15px 25px; display:flex; justify-content:space-between; align-items:center; }
        .card { border:none; box-shadow:0 4px 6px rgba(0,0,0,.05); border-radius:12px; }
        .badge { padding:6px 10px; font-size:11px; border-radius:20px; }
        .badge-PENDING { background:#f59e0b; color:#fff; }
        .badge-OFFERS_RECEIVED { background:#3b82f6; color:#fff; }
        .badge-CONFIRMED { background:#10b981; color:#fff; }
        .badge-CANCELLED { background:#ef4444; color:#fff; }
        .badge-COMPLETED { background:#6b7280; color:#fff; }
        .badge-INVESTIGATION { background:#9333ea; color:#fff; }
        .nav-link { cursor:pointer; font-weight:600; }
        .nav-link.active { border-bottom:3px solid #10b981; }
        .stat { font-size:2rem; font-weight:700; }
        table { font-size:13px; }
    </style>
</head>
<body>

<div id="admin-login" class="container text-center mt-5">
    <div class="card p-5 mx-auto" style="max-width:400px;">
        <h4>ðŸ’Ž RideLink GEM</h4>
        <p>Admin Panel</p>
        <button class="btn btn-dark btn-block" onclick="adminLogin()">Sign in with Google</button>
        <p id="error-msg" class="text-danger mt-2"></p>
    </div>
</div>

<div id="admin-dashboard" style="display:none;">
    <div class="admin-header">
        <h5>ðŸ’Ž Control Center</h5>
        <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
    </div>

    <div class="container mt-4">

        <!-- STATS -->
        <div class="row text-center mb-4">
            <div class="col-md-3"><div class="card p-3"><div class="stat" id="stat-drivers">0</div><small>Drivers</small></div></div>
            <div class="col-md-3"><div class="card p-3"><div class="stat" id="stat-riders">0</div><small>Riders</small></div></div>
            <div class="col-md-3"><div class="card p-3"><div class="stat" id="stat-requests">0</div><small>Requests</small></div></div>
            <div class="col-md-3"><div class="card p-3"><div class="stat" id="stat-wallet">â‚¹0</div><small>Total Wallet</small></div></div>
        </div>

        <!-- TABS -->
        <div class="card">
            <div class="card-header bg-white">
                <ul class="nav nav-tabs border-0">
                    <li class="nav-item"><a class="nav-link active" onclick="switchTab('drivers', this)">ðŸš– Drivers</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="switchTab('riders', this)">ðŸš¶ Riders</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="switchTab('requests', this)">ðŸ“‹ Requests</a></li>
                </ul>
            </div>

            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="bg-light">
                            <tr id="table-head"></tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

<script src="firebase-init.js"></script>
<script>
const ADMIN_EMAILS = ["rcdotopi@gmail.com"];
let currentTab = "drivers";
let users = {};
let requests = {};

auth.onAuthStateChanged(user => {
    if(user && ADMIN_EMAILS.includes(user.email)) {
        document.getElementById("admin-login").style.display="none";
        document.getElementById("admin-dashboard").style.display="block";
        loadData();
    } else {
        if(user) document.getElementById("error-msg").innerText="Access denied";
    }
});

function adminLogin() {
    auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
}
function logout() { auth.signOut(); location.reload(); }

function loadData() {
    db.ref("users").on("value", s => { users=s.val()||{}; render(); stats(); });
    db.ref("requests").on("value", s => { requests=s.val()||{}; render(); stats(); });
}

function switchTab(tab, el) {
    currentTab = tab;
    document.querySelectorAll(".nav-link").forEach(n=>n.classList.remove("active"));
    el.classList.add("active");
    render();
}

function render() {
    const head=document.getElementById("table-head");
    const body=document.getElementById("table-body");
    head.innerHTML=""; body.innerHTML="";

    if(currentTab==="drivers" || currentTab==="riders") {
        head.innerHTML="<th>Name</th><th>Email</th><th>Details</th><th>Wallet</th><th>Status</th>";
        Object.values(users).forEach(u=>{
            if(currentTab==="drivers" && u.role!=="driver") return;
            if(currentTab==="riders" && u.role!=="rider") return;
            body.innerHTML+=`
                <tr>
                    <td>${u.name||"-"}</td>
                    <td>${u.email||"-"}</td>
                    <td>${u.vehicleType||u.phone||"-"}</td>
                    <td>â‚¹${u.wallet||0}</td>
                    <td>${u.driverStatus||u.riderStatus||"pending"}</td>
                </tr>`;
        });
    }

    if(currentTab==="requests") {
        head.innerHTML="<th>Rider</th><th>Driver</th><th>Vehicle</th><th>Fare</th><th>Status</th><th>Reason</th>";
        Object.values(requests).forEach(r=>{
            body.innerHTML+=`
                <tr>
                    <td>${r.riderName||"-"}</td>
                    <td>${r.selectedDriverId||"-"}</td>
                    <td>${r.vehicleType||"-"}</td>
                    <td>${r.agreedPrice||"-"}</td>
                    <td><span class="badge badge-${r.status}">${r.status}</span></td>
                    <td>${r.cancellationReason||"-"}</td>
                </tr>`;
        });
    }
}

function stats() {
    document.getElementById("stat-drivers").innerText =
        Object.values(users).filter(u=>u.role==="driver").length;
    document.getElementById("stat-riders").innerText =
        Object.values(users).filter(u=>u.role==="rider").length;
    document.getElementById("stat-requests").innerText =
        Object.keys(requests).length;
    document.getElementById("stat-wallet").innerText =
        "â‚¹"+Object.values(users).reduce((t,u)=>t+(u.wallet||0),0);
}
</script>
</body>
</html>
