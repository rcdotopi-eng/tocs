<!DOCTYPE html>
<html lang="en">
<head>
    <title>RideLink - Passenger</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#007bff">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>

    <div class="container" style="justify-content: center; text-align: center;">
        
        <div style="font-size: 60px; margin-bottom: 10px;">üë§</div>
        <h1>Passenger App</h1>

        <div id="view-login" class="card">
            <h3>Welcome</h3>
            <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
                Secure Login for Members.
            </p>

            <button class="btn-primary" onclick="loginWithGoogle()" style="background: white; color: #444; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20">
                Continue with Google
            </button>
            
            <p id="status-text" style="margin-top: 15px; font-size: 12px; color: #999;"></p>
        </div>

        <div id="view-register" class="card" style="display: none; text-align: left;">
            <h3 style="margin-top:0; color: #007bff;">Passenger Registration</h3>
            <p style="font-size: 13px; color: #666;">Complete your profile to join.</p>

            <div class="input-group">
                <label>Full Name</label>
                <input type="text" id="reg-name">
            </div>
            <div class="input-group">
                <label>Phone Number</label>
                <input type="tel" id="reg-phone" placeholder="03xx-xxxxxxx" oninput="formatPhone(this)">
            </div>

            <hr style="border-top: 1px dashed #ddd; margin: 20px 0;">

            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffeeba; margin-bottom: 20px;">
                <h4 style="margin:0 0 5px 0; color: #856404;">‚ö†Ô∏è Security Fee Required</h4>
                <p style="font-size: 13px; margin: 0; color: #856404;">
                    To activate your account, pay <strong>Rs. 500</strong> via EasyPaisa/JazzCash.
                </p>
                <h2 style="text-align: center; margin: 10px 0; color: #333;">0314-6415764</h2>
                <p style="font-size: 12px; margin: 0; text-align: center;">
                    Send screenshot to this WhatsApp after payment.
                </p>
            </div>

            <button class="btn-green" onclick="submitRegistration()">
                I have Paid & Sent Screenshot
            </button>
        </div>

        <div id="view-pending" class="card" style="display: none;">
            <div style="font-size: 50px;">‚è≥</div>
            <h3 style="color: #e67e22;">Approval Pending</h3>
            <p style="color: #666; font-size: 14px;">
                We are verifying your payment. <br>
                This usually takes 1-2 hours.
            </p>
            <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; font-size: 12px; margin-top: 20px;">
                <strong>Admin WhatsApp:</strong><br>0314-6415764
            </div>
            <button onclick="location.reload()" style="margin-top: 20px; background: none; border: 1px solid #ddd; padding: 10px; width: 100%;">
                Check Status Again
            </button>
        </div>

    </div>

    <script src="firebase-init.js"></script>
    <script>
        let googleUser = null;
        let existingData = null;

        // 1. LOGIN
        function loginWithGoogle() {
            const btn = document.querySelector('.btn-primary');
            const txt = document.getElementById('status-text');
            btn.disabled = true; btn.style.opacity = "0.5"; txt.innerText = "Connecting...";

            const provider = new firebase.auth.GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' });

            firebase.auth().signInWithPopup(provider).then((result) => {
                googleUser = result.user;
                checkDatabase(googleUser.uid);
            }).catch((error) => {
                alert(error.message);
                btn.disabled = false; btn.style.opacity = "1";
            });
        }

        // 2. CHECK DATABASE
        function checkDatabase(uid) {
            db.ref('users/' + uid).once('value').then((snapshot) => {
                document.getElementById('view-login').style.display = 'none';

                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    existingData = userData;
                    localStorage.setItem("taxiUser", JSON.stringify(userData));

                    // CHECK SPECIFICALLY FOR RIDER STATUS
                    if (userData.riderStatus === 'active') {
                        // Already approved -> Go to App
                        window.location.href = "rider_app.html";
                    } else if (userData.riderStatus === 'pending') {
                        // Pending approval
                        document.getElementById('view-pending').style.display = 'block';
                    } else {
                        // User exists (likely a Driver) but NOT a Rider -> Show Registration
                        showRegistration(true);
                    }
                } else {
                    // New User -> Show Registration
                    showRegistration(false);
                }
            });
        }

        function showRegistration(isUpgrade) {
            document.getElementById('view-register').style.display = 'block';
            document.getElementById('reg-name').value = googleUser.displayName;
            // Pre-fill phone if they are upgrading from Driver account
            if(isUpgrade && existingData.phone) {
                document.getElementById('reg-phone').value = existingData.phone;
            }
        }

        // 3. SUBMIT REGISTRATION
        function submitRegistration() {
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;
            if(!name || !phone) return alert("Please fill all fields.");

            // We use .update() so we don't delete Driver data if it exists
            const updates = {
                name: name,
                phone: phone,
                email: googleUser.email,
                riderStatus: 'pending' // Only sets Rider Status
            };

            // If completely new user, set join date & wallet
            if(!existingData) {
                updates.joined = Date.now();
                updates.wallet = 0; 
            }

            db.ref('users/' + googleUser.uid).update(updates).then(() => {
                // Update local memory
                if(existingData) Object.assign(existingData, updates);
                else existingData = updates;
                localStorage.setItem("taxiUser", JSON.stringify(existingData));
                
                document.getElementById('view-register').style.display = 'none';
                document.getElementById('view-pending').style.display = 'block';
            });
        }

        function formatPhone(input) {
            let v = input.value.replace(/\D/g, ''); 
            if (v.length > 11) v = v.slice(0, 11);
            if (v.length > 4) v = v.slice(0, 4) + "-" + v.slice(4);
            input.value = v;
        }
    </script>
</body>
</html>
